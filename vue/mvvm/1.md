## å‰è¨€
ä½œä¸º Vue é¢è¯•ä¸­çš„å¿…è€ƒé¢˜ä¹‹ä¸€ï¼ŒVue çš„å“åº”å¼åŸç†ï¼Œæƒ³å¿…ç”¨è¿‡ Vue çš„åŒå­¦éƒ½ä¸ä¼šé™Œç”Ÿï¼Œ[Vue å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/reactivity.html) å¯¹å“åº”å¼è¦æ³¨æ„çš„é—®é¢˜ä¹Ÿéƒ½åšäº†è¯¦ç»†çš„è¯´æ˜ã€‚

ä½†æ˜¯å¯¹äºåˆšæ¥è§¦æˆ–è€…äº†è§£ä¸å¤šçš„åŒå­¦æ¥è¯´ï¼Œå¯èƒ½è¿˜ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼šä¸ºä»€ä¹ˆä¸èƒ½æ£€æµ‹åˆ°å¯¹è±¡å±æ€§çš„æ·»åŠ æˆ–åˆ é™¤ï¼Ÿä¸ºä»€ä¹ˆä¸æ”¯æŒé€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„æˆå‘˜ï¼Ÿç›¸ä¿¡çœ‹å®Œæœ¬æœŸæ–‡ç« ï¼Œä½ ä¸€å®šä¼šè±ç„¶å¼€æœ—ã€‚

æœ¬æ–‡ä¼šç»“åˆ **Vue æºç åˆ†æï¼Œé’ˆå¯¹æ•´ä¸ªå“åº”å¼åŸç†ä¸€æ­¥æ­¥æ·±å…¥**ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å·²ç»å¯¹å“åº”å¼åŸç†æœ‰ä¸€äº›è®¤è¯†å’Œäº†è§£ï¼Œå¤§å¯ä»¥ **ç›´æ¥å‰å¾€å®ç°éƒ¨åˆ† [MVVM](#MVVM)**

**æ–‡ç« ä»“åº“å’Œæºç éƒ½åœ¨ [ğŸ¹ğŸ° fe-code](https://github.com/wuyawei/fe-code)ï¼Œæ¬¢è¿ star**ã€‚

**ç»å¤§ä½¬æé†’ï¼ŒVue å¹¶ä¸å®Œå…¨æ˜¯ MVVM æ¨¡å‹ï¼Œå¤§å®¶å®¡æ…é˜…è¯»ã€‚**

> è™½ç„¶æ²¡æœ‰å®Œå…¨éµå¾ª MVVM æ¨¡å‹ï¼Œä½†æ˜¯ Vue çš„è®¾è®¡ä¹Ÿå—åˆ°äº†å®ƒçš„å¯å‘ã€‚å› æ­¤åœ¨æ–‡æ¡£ä¸­ç»å¸¸ä¼šä½¿ç”¨ vm (ViewModel çš„ç¼©å†™) è¿™ä¸ªå˜é‡åè¡¨ç¤º Vue å®ä¾‹ã€‚ â€” [Vue å®˜ç½‘](https://cn.vuejs.org/v2/guide/instance.html#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-Vue-%E5%AE%9E%E4%BE%8B)

Vue å®˜æ–¹çš„å“åº”å¼åŸç†å›¾é•‡æ¥¼ã€‚

![](https://user-gold-cdn.xitu.io/2019/4/2/169deafe6c899320?w=1200&h=750&f=png&s=21308)
## æ€è€ƒ
è¿›å…¥ä¸»é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒå¦‚ä¸‹ä»£ç ã€‚
``` html
<template>
    <div>
        <ul>
            <li v-for="(v, i) in list" :key="i">{{v.text}}</li>
        </ul>
    </div>
</template>
<script>
    export default{
        name: 'responsive',
        data() {
            return {
                list: []
            }
        },
        mounted() {
            setTimeout(_ => {
                this.list = [{text: 666}, {text: 666}, {text: 666}];
            },1000);
            setTimeout(_ => {
                this.list.forEach((v, i) => { v.text = i; });
            },2000)
        }
    }
</script>
```
æˆ‘ä»¬çŸ¥é“åœ¨ Vue ä¸­ï¼Œä¼šé€šè¿‡ `Object.defineProperty` å°† data ä¸­å®šä¹‰çš„å±æ€§åšæ•°æ®åŠ«æŒï¼Œç”¨æ¥æ”¯æŒç›¸å…³æ“ä½œçš„å‘å¸ƒè®¢é˜…ã€‚è€Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œdata ä¸­åªå®šä¹‰äº† list ä¸ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œæ‰€ä»¥ Vue ä¼šå¯¹å®ƒè¿›è¡ŒåŠ«æŒï¼Œå¹¶æ·»åŠ å¯¹åº”çš„ getter/setterã€‚

æ‰€ä»¥åœ¨ 1 s çš„æ—¶å€™ï¼Œé€šè¿‡ `this.list = [{text: 666}, {text: 666}, {text: 666}]` ç»™ list é‡æ–°èµ‹å€¼ï¼Œä¾¿ä¼šè§¦å‘ setterï¼Œè¿›è€Œé€šçŸ¥å¯¹åº”çš„è§‚å¯Ÿè€…ï¼ˆè¿™é‡Œçš„è§‚å¯Ÿè€…æ˜¯æ¨¡æ¿ç¼–è¯‘ï¼‰åšæ›´æ–°ã€‚

åœ¨ 2 s çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆé€šè¿‡æ•°ç»„éå†ï¼Œæ”¹å˜äº†æ¯ä¸€ä¸ª list æˆå‘˜çš„ text å±æ€§ï¼Œè§†å›¾å†æ¬¡æ›´æ–°ã€‚è¿™ä¸ªåœ°æ–¹éœ€è¦å¼•èµ·æˆ‘ä»¬çš„æ³¨æ„ï¼Œå¦‚æœåœ¨å¾ªç¯ä½“å†…ç›´æ¥ç”¨ `this.list[i] = {text: i}` æ¥åšæ•°æ®æ›´æ–°æ“ä½œï¼Œæ•°æ®å¯ä»¥æ­£å¸¸æ›´æ–°ï¼Œä½†æ˜¯è§†å›¾ä¸ä¼šã€‚è¿™ä¹Ÿæ˜¯å‰é¢æåˆ°çš„ï¼Œä¸æ”¯æŒé€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„æˆå‘˜ã€‚

ä½†æ˜¯æˆ‘ä»¬ç”¨ `v.text = i` è¿™æ ·çš„æ–¹å¼ï¼Œè§†å›¾å´èƒ½æ­£å¸¸æ›´æ–°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼ŸæŒ‰ç…§ä¹‹å‰è¯´çš„ï¼ŒVue ä¼šåŠ«æŒ data é‡Œçš„å±æ€§ï¼Œå¯æ˜¯ list å†…éƒ¨æˆå‘˜çš„å±æ€§ï¼Œæ˜æ˜æ²¡æœ‰è¿›è¡Œæ•°æ®åŠ«æŒå•Šï¼Œä¸ºä»€ä¹ˆä¹Ÿèƒ½æ›´æ–°è§†å›¾å‘¢ï¼Ÿ 

è¿™æ˜¯å› ä¸ºåœ¨ç»™ list åš setter æ“ä½œæ—¶ï¼Œä¼šå…ˆåˆ¤æ–­èµ‹çš„æ–°å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡çš„è¯ä¼šå†æ¬¡è¿›è¡ŒåŠ«æŒï¼Œå¹¶æ·»åŠ å’Œ list ä¸€æ ·çš„è§‚å¯Ÿè€…ã€‚

æˆ‘ä»¬æŠŠä»£ç å†ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼š
``` html
// è§†å›¾å¢åŠ äº† v-if çš„æ¡ä»¶åˆ¤æ–­
<ul>
    <li v-for="(v, i) in list" :key="i" v-if="v.status === '1'">{{v.text}}</li>
</ul>

// 2 s æ—¶ï¼Œæ–°å¢çŠ¶æ€å±æ€§ã€‚
mounted() {
    setTimeout(_ => {
        this.list = [{text: 666}, {text: 666}, {text: 666}];
    },1000);
    setTimeout(_ => {
        this.list.forEach((v, i) => {
            v.text = i;
            v.status = '1'; // æ–°å¢çŠ¶æ€
        });
    },2000)
}
```
å¦‚ä¸Šï¼Œæˆ‘ä»¬åœ¨è§†å›¾å¢åŠ äº† v-if çš„çŠ¶æ€åˆ¤æ–­ï¼Œåœ¨ 2 s çš„æ—¶å€™ï¼Œè®¾ç½®äº†çŠ¶æ€ã€‚ä½†æ˜¯äº‹ä¸æ„¿è¿ï¼Œè§†å›¾å¹¶ä¸ä¼šåƒæˆ‘ä»¬æœŸå¾…çš„é‚£æ ·åœ¨ 2 s çš„æ—¶å€™ç›´æ¥æ˜¾ç¤º 0ã€1ã€2ï¼Œè€Œæ˜¯ä¸€ç›´æ˜¯ç©ºç™½çš„ã€‚

è¿™æ˜¯å¾ˆå¤šæ–°æ‰‹æ˜“çŠ¯çš„é”™è¯¯ï¼Œå› ä¸ºç»å¸¸ä¼šæœ‰ç±»ä¼¼çš„éœ€æ±‚ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ Vue ä¸èƒ½æ£€æµ‹åˆ°å¯¹è±¡å±æ€§çš„æ·»åŠ æˆ–åˆ é™¤ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¾¾åˆ°é¢„æœŸçš„æ•ˆæœè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¾ˆç®€å•ï¼š
``` javascript
// åœ¨ 1 s è¿›è¡Œèµ‹å€¼æ“ä½œæ—¶ï¼Œé¢„ç½® status å±æ€§ã€‚
setTimeout(_ => {
    this.list = [{text: 666, status: '0'}, {text: 666, status: '0'}, {text: 666, status: '0'}];
},1000);
```
å½“ç„¶ Vue ä¹Ÿ æä¾›äº† `vm.$set( target, key, value )` æ–¹æ³•æ¥è§£å†³ç‰¹å®šæƒ…å†µä¸‹æ·»åŠ å±æ€§çš„æ“ä½œï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¸å¤ªé€‚ç”¨ã€‚
## Vue å“åº”å¼åŸç†
å‰é¢æˆ‘ä»¬è®²äº†ä¸¤ä¸ªå…·ä½“ä¾‹å­ï¼Œä¸¾äº†æ˜“çŠ¯çš„é”™è¯¯ä»¥åŠè§£å†³åŠæ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¾ç„¶åªçŸ¥é“åº”è¯¥è¿™ä¹ˆå»åšï¼Œè€Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå»åšã€‚

Vue çš„æ•°æ®åŠ«æŒä¾èµ–äº `Object.defineProperty`ï¼Œæ‰€ä»¥ä¹Ÿæ­£æ˜¯å› ä¸ºå®ƒçš„æŸäº›ç‰¹æ€§ï¼Œæ‰å¼•èµ·è¿™ä¸ªé—®é¢˜ã€‚ä¸äº†è§£è¿™ä¸ªå±æ€§çš„åŒå­¦çœ‹è¿™é‡Œ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)ã€‚
### Object.defineProperty åŸºç¡€å®ç°
> Object.defineProperty() æ–¹æ³•ä¼šç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œ å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚â€” MDN

çœ‹ä¸€ä¸ªåŸºç¡€çš„æ•°æ®åŠ«æŒçš„æ —å­ï¼Œè¿™ä¹Ÿæ˜¯å“åº”å¼æœ€æ ¹æœ¬çš„ä¾èµ–ã€‚
``` javascript
function defineReactive(obj, key, val) {
    Object.defineProperty(obj, key, {
        enumerable: true, // å¯æšä¸¾
        configurable: true, // å¯å†™
        get: function() {
            console.log('get');
            return val;
        },
        set: function(newVal) {
            // è®¾ç½®æ—¶ï¼Œå¯ä»¥æ·»åŠ ç›¸åº”çš„æ“ä½œ
            console.log('set');
            val += newVal;
        }
    });
}
let obj = {name: 'æˆé¾™å¤§å“¥', say: 'ï¼šå…¶å®æˆ‘ä¹‹å‰æ˜¯æ‹’ç»æ‹è¿™ä¸ªæ¸¸æˆå¹¿å‘Šçš„ï¼Œ'};
Object.keys(obj).forEach(k => {
    defineReactive(obj, k, obj[k]);
});
obj.say = 'åæ¥æˆ‘è¯•ç©äº†ä¸€ä¸‹ï¼Œå“‡ï¼Œå¥½çƒ­è¡€ï¼Œè›®å¥½ç©çš„';
console.log(obj.name + obj.say);
// æˆé¾™å¤§å“¥ï¼šå…¶å®æˆ‘ä¹‹å‰æ˜¯æ‹’ç»æ‹è¿™ä¸ªæ¸¸æˆå¹¿å‘Šçš„ï¼Œåæ¥æˆ‘è¯•ç©äº†ä¸€ä¸‹ï¼Œå“‡ï¼Œå¥½çƒ­è¡€ï¼Œè›®å¥½ç©çš„
obj.eat = 'é¦™è•‰'; // ** æ²¡æœ‰å“åº”
```
å¯ä»¥çœ‹è§ï¼Œ`Object.defineProperty` æ˜¯å¯¹å·²æœ‰å±æ€§è¿›è¡Œçš„åŠ«æŒæ“ä½œï¼Œæ‰€ä»¥ Vue æ‰è¦æ±‚äº‹å…ˆå°†éœ€è¦ç”¨åˆ°çš„æ•°æ®å®šä¹‰åœ¨ data ä¸­ï¼ŒåŒæ—¶ä¹Ÿæ— æ³•å“åº”å¯¹è±¡å±æ€§çš„æ·»åŠ å’Œåˆ é™¤ã€‚è¢«åŠ«æŒçš„å±æ€§ä¼šæœ‰ç›¸åº”çš„ getã€set æ–¹æ³•ã€‚

![](https://user-gold-cdn.xitu.io/2019/4/6/169f32eaaa3f173c?w=270&h=208&f=png&s=3426)

å¦å¤–ï¼Œ[Vue å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/list.html#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9) ä¸Šè¯´ï¼šç”±äº JavaScript çš„é™åˆ¶ï¼ŒVue ä¸æ”¯æŒé€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„æˆå‘˜ã€‚å¯¹äºè¿™ä¸€ç‚¹ï¼Œå…¶å®ç›´æ¥é€šè¿‡ä¸‹æ ‡æ¥å¯¹æ•°ç»„è¿›è¡ŒåŠ«æŒï¼Œæ˜¯å¯ä»¥åšåˆ°çš„ã€‚
``` javascript
let arr = [1,2,3,4,5];
arr.forEach((v, i) => { // é€šè¿‡ä¸‹æ ‡è¿›è¡ŒåŠ«æŒ
    defineReactive(arr, i, v);
});
arr[0] = 'oh nanana'; // set
```
é‚£ä¹ˆ Vue ä¸ºä»€ä¹ˆä¸è¿™ä¹ˆå¤„ç†å‘¢ï¼Ÿå°¤å¤§å®˜æ–¹å›ç­”æ˜¯æ€§èƒ½é—®é¢˜ã€‚å…³äºè¿™ä¸ªç‚¹æ›´è¯¦ç»†çš„åˆ†æï¼Œå„ä½å¯ä»¥ç§»æ­¥ [Vueä¸ºä»€ä¹ˆä¸èƒ½æ£€æµ‹æ•°ç»„å˜åŠ¨ï¼Ÿ](https://segmentfault.com/a/1190000015783546)
### Vue æºç å®ç°
> ä»¥ä¸‹ä»£ç  Vue ç‰ˆæœ¬ä¸ºï¼š2.6.10ã€‚

#### Observer
æˆ‘ä»¬çŸ¥é“äº†æ•°æ®åŠ«æŒçš„åŸºç¡€å®ç°ï¼Œé¡ºä¾¿å†çœ‹çœ‹ Vue æºç æ˜¯å¦‚ä½•åšçš„ã€‚
``` javascript
// observer/index.js
// Observer å‰çš„é¢„å¤„ç†æ–¹æ³•
export function observe (value: any, asRootData: ?boolean): Observer | void {
  if (!isObject(value) || value instanceof VNode) { // æ˜¯å¦æ˜¯å¯¹è±¡æˆ–è€…è™šæ‹Ÿdom
    return
  }
  let ob: Observer | void
  // åˆ¤æ–­æ˜¯å¦æœ‰ __ob__ å±æ€§ï¼Œæœ‰çš„è¯ä»£è¡¨æœ‰ Observer å®ä¾‹ï¼Œç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å°±åˆ›å»º Observer
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    ob = value.__ob__
  } else if ( // åˆ¤æ–­æ˜¯å¦æ˜¯å•çº¯çš„å¯¹è±¡
    shouldObserve &&
    !isServerRendering() &&
    (Array.isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value._isVue
  ) {
    ob = new Observer(value) // åˆ›å»ºObserver
  }
  if (asRootData && ob) {
    ob.vmCount++
  }
  return ob
}

// Observer å®ä¾‹
export class Observer { 
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that have this object as root $data

  constructor (value: any) {
    this.value = value
    this.dep = new Dep() // ç»™ Observer æ·»åŠ  Dep å®ä¾‹ï¼Œç”¨äºæ”¶é›†ä¾èµ–ï¼Œè¾…åŠ© vm.$set/æ•°ç»„æ–¹æ³•ç­‰
    this.vmCount = 0
    // ä¸ºè¢«åŠ«æŒçš„å¯¹è±¡æ·»åŠ __ob__å±æ€§ï¼ŒæŒ‡å‘è‡ªèº« Observer å®ä¾‹ã€‚ä½œä¸ºæ˜¯å¦ Observer çš„å”¯ä¸€æ ‡è¯†ã€‚
    def(value, '__ob__', this)
    if (Array.isArray(value)) { // åˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„
      if (hasProto) { // åˆ¤æ–­æ˜¯å¦æ”¯æŒ__proto__å±æ€§ï¼Œç”¨æ¥å¤„ç†æ•°ç»„æ–¹æ³•
        protoAugment(value, arrayMethods) // ç»§æ‰¿
      } else {
        copyAugment(value, arrayMethods, arrayKeys) // æ‹·è´
      }
      this.observeArray(value) // åŠ«æŒæ•°ç»„æˆå‘˜
    } else {
      this.walk(value) // åŠ«æŒå¯¹è±¡
    }
  }

  walk (obj: Object) { // åªæœ‰åœ¨å€¼æ˜¯ Object çš„æ—¶å€™ï¼Œæ‰ç”¨æ­¤æ–¹æ³•
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i]) // æ•°æ®åŠ«æŒæ–¹æ³•
    }
  }

  observeArray (items: Array<any>) { // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™è°ƒç”¨ observe å¤„ç†æ•°ç»„æˆå‘˜
    for (let i = 0, l = items.length; i < l; i++) {
      observe(items[i]) // ä¾æ¬¡å¤„ç†æ•°ç»„æˆå‘˜
    }
  }
}
```
ä¸Šé¢éœ€è¦æ³¨æ„çš„æ˜¯ `__ob__` å±æ€§ï¼Œé¿å…é‡å¤åˆ›å»ºï¼Œ`__ob__`ä¸Šæœ‰ä¸€ä¸ª dep å±æ€§ï¼Œä½œä¸ºä¾èµ–æ”¶é›†çš„å‚¨å­˜å™¨ï¼Œåœ¨ vm.$setã€æ•°ç»„çš„ push ç­‰å¤šç§æ–¹æ³•ä¸Šéœ€è¦ç”¨åˆ°ã€‚ç„¶å Vue å°†å¯¹è±¡å’Œæ•°ç»„åˆ†å¼€å¤„ç†ï¼Œæ•°ç»„åªæ·±åº¦ç›‘å¬äº†å¯¹è±¡æˆå‘˜ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹å‰è¯´çš„å¯¼è‡´ä¸èƒ½ç›´æ¥æ“ä½œç´¢å¼•çš„åŸå› ã€‚ä½†æ˜¯æ•°ç»„çš„ä¸€äº›æ–¹æ³•æ˜¯å¯ä»¥æ­£å¸¸å“åº”çš„ï¼Œæ¯”å¦‚ pushã€pop ç­‰ï¼Œè¿™ä¾¿æ˜¯å› ä¸ºä¸Šè¿°åˆ¤æ–­å“åº”å¯¹è±¡æ˜¯å¦æ˜¯æ•°ç»„æ—¶ï¼Œåšçš„å¤„ç†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“ä»£ç ã€‚
``` javascript
// observer/index.js
import { arrayMethods } from './array'
const arrayKeys = Object.getOwnPropertyNames(arrayMethods)

// export function observe çœç•¥éƒ¨åˆ†ä»£ç 
if (Array.isArray(value)) { // åˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„
  if (hasProto) { // åˆ¤æ–­æ˜¯å¦æ”¯æŒ__proto__å±æ€§ï¼Œç”¨æ¥å¤„ç†æ•°ç»„æ–¹æ³•
    protoAugment(value, arrayMethods) // ç»§æ‰¿
  } else {
    copyAugment(value, arrayMethods, arrayKeys) // æ‹·è´
  }
  this.observeArray(value) // åŠ«æŒæ•°ç»„æˆå‘˜
}
// Â·Â·Â·

// ç›´æ¥ç»§æ‰¿ arrayMethods
function protoAugment (target, src: Object) { 
  target.__proto__ = src
}
// ä¾æ¬¡æ‹·è´æ•°ç»„æ–¹æ³•
function copyAugment (target: Object, src: Object, keys: Array<string>) {
  for (let i = 0, l = keys.length; i < l; i++) {
    const key = keys[i]
    def(target, key, src[key])
  }
}

// util/lang.js  def æ–¹æ³•é•¿è¿™æ ·ï¼Œç”¨æ¥ç»™å¯¹è±¡æ·»åŠ å±æ€§
export function def (obj: Object, key: string, val: any, enumerable?: boolean) {
  Object.defineProperty(obj, key, {
    value: val,
    enumerable: !!enumerable,
    writable: true,
    configurable: true
  })
}
```
å¯ä»¥çœ‹åˆ°å…³é”®ç‚¹åœ¨ `arrayMethods`ä¸Šï¼Œæˆ‘ä»¬å†ç»§ç»­çœ‹ï¼š
``` javascript
// observer/array.js
import { def } from '../util/index'

const arrayProto = Array.prototype // å­˜å‚¨æ•°ç»„åŸå‹ä¸Šçš„æ–¹æ³•
export const arrayMethods = Object.create(arrayProto) // åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œé¿å…ç›´æ¥æ”¹å˜æ•°ç»„åŸå‹æ–¹æ³•

const methodsToPatch = [
  'push',
  'pop',
  'shift',
  'unshift',
  'splice',
  'sort',
  'reverse'
]

// é‡å†™ä¸Šè¿°æ•°ç»„æ–¹æ³•
methodsToPatch.forEach(function (method) {
  const original = arrayProto[method]
  def(arrayMethods, method, function mutator (...args) { // 
    const result = original.apply(this, args) // æ‰§è¡ŒæŒ‡å®šæ–¹æ³•
    const ob = this.__ob__ // æ‹¿åˆ°è¯¥æ•°ç»„çš„ ob å®ä¾‹
    let inserted
    switch (method) {
      case 'push':
      case 'unshift':
        inserted = args
        break
      case 'splice':
        inserted = args.slice(2) // splice æ¥æ”¶çš„å‰ä¸¤ä¸ªå‚æ•°æ˜¯ä¸‹æ ‡
        break
    }
    if (inserted) ob.observeArray(inserted) // åŸæ•°ç»„çš„æ–°å¢éƒ¨åˆ†éœ€è¦é‡æ–° observe
    // notify change
    ob.dep.notify() // æ‰‹åŠ¨å‘å¸ƒï¼Œåˆ©ç”¨__ob__ çš„ dep å®ä¾‹
    return result
  })
})
```
ç”±æ­¤å¯è§ï¼ŒVue é‡å†™äº†éƒ¨åˆ†æ•°ç»„æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œåšäº†æ‰‹åŠ¨å‘å¸ƒã€‚ä½†æ˜¯ Vue çš„æ•°æ®åŠ«æŒéƒ¨åˆ†æˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°ï¼Œåœ¨ç¬¬ä¸€éƒ¨åˆ†çš„ observer å‡½æ•°çš„ä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ª defineReactive æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š
``` javascript
export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  const dep = new Dep() // å®ä¾‹ä¸€ä¸ª Dep å®ä¾‹

  const property = Object.getOwnPropertyDescriptor(obj, key) // è·å–å¯¹è±¡è‡ªèº«å±æ€§
  if (property && property.configurable === false) { // æ²¡æœ‰å±æ€§æˆ–è€…å±æ€§ä¸å¯å†™å°±æ²¡å¿…è¦åŠ«æŒäº†
    return
  }

  // å…¼å®¹é¢„å®šä¹‰çš„ getter/setter
  const getter = property && property.get
  const setter = property && property.set
  if ((!getter || setter) && arguments.length === 2) { // åˆå§‹åŒ– val
    val = obj[key]
  }
  // é»˜è®¤ç›‘å¬å­å¯¹è±¡ï¼Œä» observe å¼€å§‹ï¼Œè¿”å› __ob__ å±æ€§ å³ Observer å®ä¾‹
  let childOb = !shallow && observe(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      const value = getter ? getter.call(obj) : val // æ‰§è¡Œé¢„è®¾çš„getterè·å–å€¼
      if (Dep.target) { // ä¾èµ–æ”¶é›†çš„å…³é”®
        dep.depend() // ä¾èµ–æ”¶é›†ï¼Œåˆ©ç”¨äº†å‡½æ•°é—­åŒ…çš„ç‰¹æ€§
        if (childOb) { // å¦‚æœæœ‰å­å¯¹è±¡ï¼Œåˆ™æ·»åŠ åŒæ ·çš„ä¾èµ–
          childOb.dep.depend() // å³ Observeræ—¶çš„ this.dep = new Dep();
          if (Array.isArray(value)) { // value æ˜¯æ•°ç»„çš„è¯è°ƒç”¨æ•°ç»„çš„æ–¹æ³•
            dependArray(value)
          }
        }
      }
      return value
    },
    set: function reactiveSetter (newVal) {
      const value = getter ? getter.call(obj) : val
      // åŸæœ‰å€¼å’Œæ–°å€¼æ¯”è¾ƒï¼Œå€¼ä¸€æ ·åˆ™ä¸åšå¤„ç†
      // newVal !== newVal && value !== value è¿™ä¸ªæ¯”è¾ƒæœ‰æ„æ€ï¼Œä½†å…¶å®æ˜¯ä¸ºäº†å¤„ç† NaN
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      if (process.env.NODE_ENV !== 'production' && customSetter) {
        customSetter()
      }
      if (getter && !setter) return
      if (setter) { // æ‰§è¡Œé¢„è®¾setter
        setter.call(obj, newVal)
      } else { // æ²¡æœ‰é¢„è®¾ç›´æ¥èµ‹å€¼
        val = newVal
      }
      childOb = !shallow && observe(newVal) // æ˜¯å¦è¦è§‚å¯Ÿæ–°è®¾ç½®çš„å€¼
      dep.notify() // å‘å¸ƒï¼Œåˆ©ç”¨äº†å‡½æ•°é—­åŒ…çš„ç‰¹æ€§
    }
  })
}
// å¤„ç†æ•°ç»„
function dependArray (value: Array<any>) {
  for (let e, i = 0, l = value.length; i < l; i++) {
    e = value[i]
    e && e.__ob__ && e.__ob__.dep.depend() // å¦‚æœæ•°ç»„æˆå‘˜æœ‰ __ob__ï¼Œåˆ™æ·»åŠ ä¾èµ–
    if (Array.isArray(e)) { // æ•°ç»„æˆå‘˜è¿˜æ˜¯æ•°ç»„ï¼Œé€’å½’è°ƒç”¨
      dependArray(e)
    }
  }
}
```
#### Dep
åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¼„æ‡‚äº† Vue çš„æ•°æ®åŠ«æŒä»¥åŠæ•°ç»„æ–¹æ³•é‡å†™ï¼Œä½†æ˜¯åˆæœ‰äº†æ–°çš„ç–‘æƒ‘ï¼ŒDep æ˜¯åšä»€ä¹ˆçš„ï¼ŸDep æ˜¯ä¸€ä¸ªå‘å¸ƒè€…ï¼Œå¯ä»¥è¢«å¤šä¸ªè§‚å¯Ÿè€…è®¢é˜…ã€‚
``` javascript
// observer/dep.js

let uid = 0
export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array<Watcher>;

  constructor () {
    this.id = uid++ // å”¯ä¸€id
    this.subs = [] // è§‚å¯Ÿè€…é›†åˆ
  }
 // æ·»åŠ è§‚å¯Ÿè€…
  addSub (sub: Watcher) {
    this.subs.push(sub)
  }
 // ç§»é™¤è§‚å¯Ÿè€…
  removeSub (sub: Watcher) {
    remove(this.subs, sub)
  }
  
  depend () { // æ ¸å¿ƒï¼Œå¦‚æœå­˜åœ¨ Dep.targetï¼Œåˆ™è¿›è¡Œä¾èµ–æ”¶é›†æ“ä½œ
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    const subs = this.subs.slice() // é¿å…æ±¡æŸ“åŸæ¥çš„é›†åˆ
    // å¦‚æœä¸æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œå…ˆè¿›è¡Œæ’åºï¼Œä¿è¯è§‚å¯Ÿè€…æ‰§è¡Œé¡ºåº
    if (process.env.NODE_ENV !== 'production' && !config.async) {
      subs.sort((a, b) => a.id - b.id)
    }
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update() // å‘å¸ƒæ‰§è¡Œ
    }
  }
}

Dep.target = null // æ ¸å¿ƒï¼Œç”¨äºé—­åŒ…æ—¶ï¼Œä¿å­˜ç‰¹å®šçš„å€¼
const targetStack = []
// ç»™ Dep.target èµ‹å€¼å½“å‰Watcherï¼Œå¹¶æ·»åŠ è¿›targetæ ˆ
export function pushTarget (target: ?Watcher) {
  targetStack.push(target)
  Dep.target = target
}
// ç§»é™¤æœ€åä¸€ä¸ªWatcherï¼Œå¹¶å°†å‰©ä½™targetæ ˆçš„æœ€åä¸€ä¸ªèµ‹å€¼ç»™ Dep.target
export function popTarget () {
  targetStack.pop()
  Dep.target = targetStack[targetStack.length - 1]
}
```
#### Watcher
å•ä¸ªçœ‹ Dep å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘ä»¬ç»“åˆ Watcher ä¸€èµ·æ¥çœ‹ã€‚
``` javascript
// observer/watcher.js

let uid = 0
export default class Watcher {
  // ...
  constructor (
    vm: Component, // ç»„ä»¶å®ä¾‹å¯¹è±¡
    expOrFn: string | Function, // è¦è§‚å¯Ÿçš„è¡¨è¾¾å¼ï¼Œå‡½æ•°ï¼Œæˆ–è€…å­—ç¬¦ä¸²ï¼Œåªè¦èƒ½è§¦å‘å–å€¼æ“ä½œ
    cb: Function, // è¢«è§‚å¯Ÿè€…å‘ç”Ÿå˜åŒ–åçš„å›è°ƒ
    options?: ?Object, // å‚æ•°
    isRenderWatcher?: boolean // æ˜¯å¦æ˜¯æ¸²æŸ“å‡½æ•°çš„è§‚å¯Ÿè€…
  ) {
    this.vm = vm // Watcheræœ‰ä¸€ä¸ª vm å±æ€§ï¼Œè¡¨æ˜å®ƒæ˜¯å±äºå“ªä¸ªç»„ä»¶çš„
    if (isRenderWatcher) {
      vm._watcher = this
    }
    vm._watchers.push(this) // ç»™ç»„ä»¶å®ä¾‹çš„_watcherså±æ€§æ·»åŠ è§‚å¯Ÿè€…å®ä¾‹
    // options
    if (options) {
      this.deep = !!options.deep // æ·±åº¦
      this.user = !!options.user
      this.lazy = !!options.lazy
      this.sync = !!options.sync // åŒæ­¥æ‰§è¡Œ
      this.before = options.before
    } else {
      this.deep = this.user = this.lazy = this.sync = false
    }
    this.cb = cb // å›è°ƒ
    this.id = ++uid // uid for batching // å”¯ä¸€æ ‡è¯†
    this.active = true // è§‚å¯Ÿè€…å®ä¾‹æ˜¯å¦æ¿€æ´»
    this.dirty = this.lazy // for lazy watchers
    // é¿å…ä¾èµ–é‡å¤æ”¶é›†çš„å¤„ç†
    this.deps = []
    this.newDeps = []
    this.depIds = new Set()
    this.newDepIds = new Set()
    
    this.expression = process.env.NODE_ENV !== 'production'
      ? expOrFn.toString()
      : ''
    // parse expression for getter
    if (typeof expOrFn === 'function') {
      this.getter = expOrFn
    } else { // ç±»ä¼¼äº Obj.a çš„å­—ç¬¦ä¸²
      this.getter = parsePath(expOrFn)
      if (!this.getter) {
        this.getter = noop // ç©ºå‡½æ•°
        process.env.NODE_ENV !== 'production' && warn(
          `Failed watching path: "${expOrFn}" ` +
          'Watcher only accepts simple dot-delimited paths. ' +
          'For full control, use a function instead.',
          vm
        )
      }
    }
    this.value = this.lazy
      ? undefined
      : this.get()
  }

  get () { // è§¦å‘å–å€¼æ“ä½œï¼Œè¿›è€Œè§¦å‘å±æ€§çš„getter
    pushTarget(this) // Dep ä¸­æåˆ°çš„ï¼šç»™ Dep.target èµ‹å€¼
    let value
    const vm = this.vm
    try {
      // æ ¸å¿ƒï¼Œè¿è¡Œè§‚å¯Ÿè€…è¡¨è¾¾å¼ï¼Œè¿›è¡Œå–å€¼ï¼Œè§¦å‘getterï¼Œä»è€Œåœ¨é—­åŒ…ä¸­æ·»åŠ watcher
      value = this.getter.call(vm, vm)
    } catch (e) {
      if (this.user) {
        handleError(e, vm, `getter for watcher "${this.expression}"`)
      } else {
        throw e
      }
    } finally {
      if (this.deep) { // å¦‚æœè¦æ·±åº¦ç›‘æµ‹ï¼Œå†å¯¹ value æ‰§è¡Œæ“ä½œ
        traverse(value)
      }
      // æ¸…ç†ä¾èµ–æ”¶é›†
      popTarget()
      this.cleanupDeps()
    }
    return value
  }

  addDep (dep: Dep) {
    const id = dep.id
    if (!this.newDepIds.has(id)) { // é¿å…ä¾èµ–é‡å¤æ”¶é›†
      this.newDepIds.add(id)
      this.newDeps.push(dep)
      if (!this.depIds.has(id)) {
        dep.addSub(this) // dep æ·»åŠ è®¢é˜…è€…
      }
    }
  }

  update () { // æ›´æ–°
    /* istanbul ignore else */
    if (this.lazy) {
      this.dirty = true
    } else if (this.sync) {
      this.run() // åŒæ­¥ç›´æ¥è¿è¡Œ
    } else { // å¦åˆ™åŠ å…¥å¼‚æ­¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
      queueWatcher(this)
    }
  }
}
```
åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å¤§æ¦‚æ€»ç»“ä¸€äº›æ•´ä¸ªå“åº”å¼ç³»ç»Ÿçš„æµç¨‹ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´çš„ **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šç¬¬ä¸€æ­¥å½“ç„¶æ˜¯é€šè¿‡ observer è¿›è¡Œæ•°æ®åŠ«æŒï¼Œç„¶ååœ¨éœ€è¦è®¢é˜…çš„åœ°æ–¹ï¼ˆå¦‚ï¼šæ¨¡ç‰ˆç¼–è¯‘ï¼‰ï¼Œæ·»åŠ è§‚å¯Ÿè€…ï¼ˆwatcherï¼‰ï¼Œå¹¶ç«‹åˆ»é€šè¿‡å–å€¼æ“ä½œè§¦å‘æŒ‡å®šå±æ€§çš„ getter æ–¹æ³•ï¼Œä»è€Œå°†è§‚å¯Ÿè€…æ·»åŠ è¿› Dep ï¼ˆåˆ©ç”¨äº†é—­åŒ…çš„ç‰¹æ€§ï¼Œè¿›è¡Œä¾èµ–æ”¶é›†ï¼‰ï¼Œç„¶ååœ¨ Setter è§¦å‘çš„æ—¶å€™ï¼Œè¿›è¡Œ notifyï¼Œé€šçŸ¥ç»™æ‰€æœ‰è§‚å¯Ÿè€…å¹¶è¿›è¡Œç›¸åº”çš„ updateã€‚

æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šDep å°±å¥½æ¯”æ˜¯æ˜é‡‘ï¼Œæ˜é‡‘æœ‰å¾ˆå¤šä½œè€…ï¼ˆç›¸å½“äº data çš„å¾ˆå¤šå±æ€§ï¼‰ã€‚æˆ‘ä»¬è‡ªç„¶éƒ½æ˜¯å……å½“è®¢é˜…è€…ï¼ˆwatcherï¼‰è§’è‰²ï¼Œåœ¨æ˜é‡‘ï¼ˆDepï¼‰è¿™é‡Œå…³æ³¨äº†æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä½œè€…ï¼Œæ¯”å¦‚ï¼šæ±Ÿä¸‰ç–¯ï¼Œå‘Šè¯‰å®ƒæ±Ÿä¸‰ç–¯æ›´æ–°äº†å°±æé†’æˆ‘å»çœ‹ã€‚é‚£ä¹ˆæ¯å½“æ±Ÿä¸‰ç–¯æœ‰æ–°å†…å®¹æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šæ”¶åˆ°ç±»ä¼¼è¿™æ ·çš„æé†’ï¼š`æ±Ÿä¸‰ç–¯å‘å¸ƒäº†ã€2019 å‰ç«¯è¿›é˜¶ä¹‹è·¯ ***ã€‘`ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å»çœ‹äº†ã€‚

ä½†æ˜¯ï¼Œæ¯ä¸ª watcher å¯ä»¥è®¢é˜…å¾ˆå¤šä½œè€…ï¼Œæ¯ä¸ªä½œè€…ä¹Ÿéƒ½ä¼šæ›´æ–°æ–‡ç« ã€‚é‚£ä¹ˆæ²¡æœ‰å…³æ³¨æ±Ÿä¸‰ç–¯çš„ç”¨æˆ·ä¼šæ”¶åˆ°æé†’å— ï¼Ÿä¸ä¼šï¼Œåªç»™å·²ç»è®¢é˜…äº†çš„ç”¨æˆ·å‘é€æé†’ï¼Œè€Œä¸”åªæœ‰æ±Ÿä¸‰ç–¯æ›´æ–°äº†æ‰æé†’ï¼Œä½ è®¢é˜…çš„æ˜¯æ±Ÿä¸‰ç–¯ï¼Œå¯æ˜¯ç«™é•¿æ›´æ–°äº†éœ€è¦æé†’ä½ å—ï¼Ÿå½“ç„¶ä¸éœ€è¦ã€‚è¿™ï¼Œä¹Ÿå°±æ˜¯é—­åŒ…éœ€è¦åšçš„äº‹æƒ…ã€‚
## Proxy
> Proxy å¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚â€œæ‹¦æˆªâ€ï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚â€” é˜®ä¸€å³°è€å¸ˆçš„ [ECMAScript 6 å…¥é—¨](http://es6.ruanyifeng.com/#docs/proxy)

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒVue 3.0 è¦ç”¨ `Proxy` æ›¿æ¢ `Object.defineProperty`ï¼Œé‚£ä¹ˆè¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”å¦‚ä¸Šè¿° Vue ç°å­˜çš„ä¸¤ä¸ªé—®é¢˜ï¼Œä¸èƒ½å“åº”å¯¹è±¡å±æ€§çš„æ·»åŠ å’Œåˆ é™¤ä»¥åŠä¸èƒ½ç›´æ¥æ“ä½œæ•°ç»„ä¸‹æ ‡çš„é—®é¢˜ï¼Œéƒ½å¯ä»¥è§£å†³ã€‚å½“ç„¶ä¹Ÿæœ‰ä¸å¥½çš„ï¼Œé‚£å°±æ˜¯å…¼å®¹æ€§é—®é¢˜ï¼Œè€Œä¸”è¿™ä¸ªå…¼å®¹æ€§é—®é¢˜ babel è¿˜æ— æ³•è§£å†³ã€‚
### åŸºç¡€ç”¨æ³•
æˆ‘ä»¬ç”¨ Proxy æ¥ç®€å•å®ç°ä¸€ä¸ªæ•°æ®åŠ«æŒã€‚
``` javascript
let obj = {};
// ä»£ç† obj
let handler = {
    get: function(target, key, receiver) {
        console.log('get', key);
        return Reflect.get(target, key, receiver);
    },
    set: function(target, key, value, receiver) {
        console.log('set', key, value);
        return Reflect.set(target, key, value, receiver);
    },
    deleteProperty(target, key) {
        console.log('delete', key);
        delete target[key];
        return true;
    }
};
let data = new Proxy(obj, handler);
// ä»£ç†ååªèƒ½ä½¿ç”¨ä»£ç†å¯¹è±¡ dataï¼Œå¦åˆ™è¿˜ç”¨ obj è‚¯å®šæ²¡ä½œç”¨
console.log(data.name); // get name ã€undefined
data.name = 'å°¹å¤©ä»‡'; // set name å°¹å¤©ä»‡
delete data.name; // delete name
```
åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œobj æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œé€šè¿‡ Proxy ä»£ç†åï¼Œæ·»åŠ å’Œåˆ é™¤å±æ€§ä¹Ÿèƒ½å¤Ÿå¾—åˆ°åé¦ˆã€‚å†æ¥çœ‹ä¸€ä¸‹æ•°ç»„çš„ä»£ç†ï¼š
``` javascript
let arr = ['å°¹å¤©ä»‡', 'æˆ‘æ˜¯ä¸€ä¸ªæ¼”å‘˜', 'æŸ³é£˜é£˜', 'æ­»è·‘é¾™å¥—çš„'];
let array = new Proxy(arr, handler);
array[1] = 'æˆ‘å…»ä½ å•Š'; // set 1 æˆ‘å…»ä½ å•Š
array[3] = 'å…ˆç®¡å¥½ä½ è‡ªå·±å§ï¼Œå‚»ç“œã€‚'; // set 3 å…ˆç®¡å¥½ä½ è‡ªå·±å§ï¼Œå‚»ç“œã€‚
```
æ•°ç»„ç´¢å¼•çš„è®¾ç½®ä¹Ÿæ˜¯å®Œå…¨ hold å¾—ä½å•Šï¼Œå½“ç„¶ Proxy çš„ç”¨å¤„ä¹Ÿä¸ä»…ä»…æ˜¯è¿™äº›ï¼Œæ”¯æŒæ‹¦æˆªçš„æ“ä½œå°±æœ‰ 13 ç§ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹ [é˜®ä¸€å³°è€å¸ˆçš„ä¹¦](http://es6.ruanyifeng.com/#docs/proxy)ï¼Œè¿™é‡Œå°±ä¸å†å•°å—¦ã€‚
### Proxy å®ç°è§‚å¯Ÿè€…æ¨¡å¼
æˆ‘ä»¬å‰é¢åˆ†æäº† Vue çš„æºç ï¼Œä¹Ÿäº†è§£äº†è§‚å¯Ÿè€…æ¨¡å¼çš„åŸºæœ¬åŸç†ã€‚é‚£ç”¨ Proxy å¦‚ä½•å®ç°è§‚å¯Ÿè€…å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç®€å•å†™ä¸€ä¸‹ï¼š
``` javascript
class Dep {
    constructor() {
        this.subs = new Set(); 
        // Set ç±»å‹ï¼Œä¿è¯ä¸ä¼šé‡å¤
    }
    addSub(sub) { // æ·»åŠ è®¢é˜…è€…
        this.subs.add(sub);
    }
    notify(key) { // é€šçŸ¥è®¢é˜…è€…æ›´æ–°
        this.subs.forEach(sub => {
            sub.update();
        });
    }
}
class Watcher { // è§‚å¯Ÿè€…
    constructor(obj, key, cb) {
        this.obj = obj;
        this.key = key;
        this.cb = cb; // å›è°ƒ
        this.value = this.get(); // è·å–è€æ•°æ®
    }
    get() { // å–å€¼è§¦å‘é—­åŒ…ï¼Œå°†è‡ªèº«æ·»åŠ åˆ°depä¸­
        Dep.target = this; // è®¾ç½® Dep.target ä¸ºè‡ªèº«
        let value = this.obj[this.key];
        Dep.target = null; // å–å€¼å®Œå è®¾ç½®ä¸ºnul
        return value;
    }
    // æ›´æ–°
    update() {
        let newVal = this.obj[this.key];
        if (this.value !== newVal) {
            this.cb(newVal);
            this.value = newVal;
        }
    }
}
function Observer(obj) {
    Object.keys(obj).forEach(key => { // åšæ·±åº¦ç›‘å¬
        if (typeof obj[key] === 'object') {
            obj[key] = Observer(obj[key]);
        }
    });
    let dep = new Dep();
    let handler = {
        get: function (target, key, receiver) {
            Dep.target && dep.addSub(Dep.target);
            // å­˜åœ¨ Dep.targetï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°depå®ä¾‹ä¸­
            return Reflect.get(target, key, receiver);
        },
        set: function (target, key, value, receiver) {
            let result = Reflect.set(target, key, value, receiver);
            dep.notify(); // è¿›è¡Œå‘å¸ƒ
            return result;
        }
    };
    return new Proxy(obj, handler)
}
```
ä»£ç æ¯”è¾ƒç®€çŸ­ï¼Œå°±æ”¾åœ¨ä¸€å—äº†ã€‚æ•´ä½“æ€è·¯å’Œ Vue çš„å·®ä¸å¤šï¼Œéœ€è¦æ³¨æ„çš„ç‚¹ä»æ—§æ˜¯ get æ“ä½œæ—¶çš„é—­åŒ…ç¯å¢ƒï¼Œä½¿å¾— `Dep.target && dep.addSub(Dep.target)` å¯ä»¥ä¿è¯å†æ¯ä¸ªå±æ€§çš„ getter è§¦å‘æ—¶ï¼Œæ˜¯å½“å‰ Watcher å®ä¾‹ã€‚é—­åŒ…ä¸å¥½ç†è§£çš„è¯ï¼Œå¯ä»¥ç±»æ¯”ä¸€ä¸‹ for å¾ªç¯ è¾“å‡º 1ã€2ã€3ã€4ã€5 çš„ä¾‹å­ã€‚

å†çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š
``` javascript
let data = {
    name: 'æ¸£æ¸£è¾‰'
};
function print1(data) {
    console.log('æˆ‘ç³»', data);
}
function print2(data) {
    console.log('æˆ‘ä»Šå¹´', data);
}
data = Observer(data);
new Watcher(data, 'name', print1);
data.name = 'æ¨è¿‡'; // æˆ‘ç³» æ¨è¿‡

new Watcher(data, 'age', print2);
data.age = '24'; // æˆ‘ä»Šå¹´ 24
```
## MVVM
è¯´äº†é‚£ä¹ˆå¤šï¼Œè¯¥ç»ƒç»ƒæ‰‹äº†ã€‚Vue å¤§å¤§æé«˜äº†å‰ç«¯er çš„ç”Ÿäº§åŠ›ï¼Œæˆ‘ä»¬è¿™æ¬¡å°±å‚è€ƒ Vue è‡ªå·±å®ç°ä¸€ä¸ªç®€æ˜“çš„ Vue æ¡†æ¶ã€‚

> å®ç°éƒ¨åˆ†å‚è€ƒè‡ª [å‰–æVueå®ç°åŸç† - å¦‚ä½•å®ç°åŒå‘ç»‘å®šmvvm](https://github.com/DMQ/mvvm)

### ä»€ä¹ˆæ˜¯ MVVM ï¼Ÿ
ç®€å•ä»‹ç»ä¸€ä¸‹ MVVMï¼Œæ›´å…¨é¢çš„è®²è§£ï¼Œå¤§å®¶å¯ä»¥çœ‹è¿™é‡Œ [MVVM æ¨¡å¼](https://docs.microsoft.com/en-us/previous-versions/msp-n-p/hh848246(v=pandp.10))ã€‚MVVM çš„å…¨ç§°æ˜¯ Model-View-ViewModelï¼Œå®ƒæ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œæœ€æ—©ç”±å¾®è½¯æå‡ºï¼Œå€Ÿé‰´äº† MVC ç­‰æ¨¡å¼çš„æ€æƒ³ã€‚

ViewModel è´Ÿè´£æŠŠ Model çš„æ•°æ®åŒæ­¥åˆ° View æ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜è´Ÿè´£æŠŠ View å¯¹æ•°æ®çš„ä¿®æ”¹åŒæ­¥å› Modelã€‚è€Œ Model å±‚ä½œä¸ºæ•°æ®å±‚ï¼Œå®ƒåªå…³å¿ƒæ•°æ®æœ¬èº«ï¼Œä¸å…³å¿ƒæ•°æ®å¦‚ä½•æ“ä½œå’Œå±•ç¤ºï¼›View æ˜¯è§†å›¾å±‚ï¼Œè´Ÿè´£å°†æ•°æ®æ¨¡å‹è½¬åŒ–ä¸º UI ç•Œé¢å±•ç°ç»™ç”¨æˆ·ã€‚

![](https://user-gold-cdn.xitu.io/2019/4/9/169ffa330a643c73?w=406&h=279&f=png&s=20155)

> å›¾ç‰‡æ¥è‡ª [MVVM æ¨¡å¼](https://docs.microsoft.com/en-us/previous-versions/msp-n-p/hh848246(v=pandp.10))

### å¦‚ä½•å®ç°ä¸€ä¸ª MVVMï¼Ÿ
æƒ³çŸ¥é“å¦‚ä½•å®ç°ä¸€ä¸ª MVVMï¼Œè‡³å°‘æˆ‘ä»¬å¾—å…ˆçŸ¥é“ MVVM æœ‰ä»€ä¹ˆã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹å¤§ä½“è¦åšæˆä¸ªä»€ä¹ˆæ¨¡æ ·ã€‚
``` html
<body>
<div id="app">
    å§“åï¼š<input type="text" v-model="name"> <br>
    å¹´é¾„ï¼š<input type="text" v-model="age"> <br>
    èŒä¸šï¼š<input type="text" v-model="profession"> <br>
    <p> è¾“å‡ºï¼š{{info}} </p>
    <button v-on:click="clear">æ¸…ç©º</button>
</div>
</body>
<script src="mvvm.js"></script>
<script>
    const app = new MVVM({
        el: '#app',
        data: {
            name: '',
            age: '',
            profession: ''
        },
        methods: {
            clear() {
                this.name = '';
                this.age =  '';
                this.profession = '';
            }
        },
        computed: {
            info() {
                return `æˆ‘å«${this.name}ï¼Œä»Šå¹´${this.age}ï¼Œæ˜¯ä¸€å${this.profession}`;
            }
        }
    })
</script>
```
è¿è¡Œæ•ˆæœï¼š

![](https://user-gold-cdn.xitu.io/2019/4/9/16a02800e8074cc2?w=456&h=202&f=png&s=3727)

å¥½ï¼Œçœ‹èµ·æ¥æ˜¯æ¨¡ä»¿ï¼ˆæŠ„è¢­ï¼‰äº† Vue çš„ä¸€äº›åŸºæœ¬åŠŸèƒ½ï¼Œæ¯”å¦‚åŒå‘ç»‘å®šã€computedã€v-onç­‰ç­‰ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¤§è‡´ç”»ä¸€ä¸‹åŸç†å›¾ã€‚

![](https://user-gold-cdn.xitu.io/2019/4/9/16a001f32f9e505c?w=700&h=481&f=jpeg&s=101106)

ä»å›¾ä¸­çœ‹ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿæ•°æ®åŠ«æŒã€æ•°æ®ä»£ç†ã€æ¨¡æ¿ç¼–è¯‘ã€å‘å¸ƒè®¢é˜…ï¼Œå’¦ï¼Œç­‰ä¸€ä¸‹ï¼Œè¿™äº›åè¯æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Ÿè¿™ä¸å°±æ˜¯ä¹‹å‰åˆ†æ Vue æºç æ—¶å€™åšçš„äº‹å—ï¼Ÿï¼ˆæ˜¯å•Šï¼Œæ˜¯å•Šï¼Œå¯ä¸å°±æ˜¯æŠ„çš„ Vue å˜›ï¼‰ã€‚OKï¼Œæ•°æ®åŠ«æŒã€å‘å¸ƒè®¢é˜…æˆ‘ä»¬éƒ½æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œå¯æ˜¯æ¨¡æ¿ç¼–è¯‘è¿˜æ²¡æœ‰å¤´ç»ªã€‚ä¸æ€¥ï¼Œè¿™å°±å¼€å§‹ã€‚
### new MVVM()
æˆ‘ä»¬æŒ‰ç…§åŸç†å›¾çš„æ€è·¯ï¼Œç¬¬ä¸€æ­¥æ˜¯ `new MVVM()`ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–ã€‚åˆå§‹åŒ–çš„æ—¶å€™è¦åšäº›ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥æƒ³åˆ°çš„æ˜¯ï¼Œæ•°æ®çš„åŠ«æŒä»¥åŠæ¨¡æ¿ï¼ˆè§†å›¾ï¼‰çš„åˆå§‹åŒ–ã€‚
``` javascript
class MVVM {
    constructor(options) { // åˆå§‹åŒ–
        this.$el = options.el;
        this.$data = options.data;
        if(this.$el){ // å¦‚æœæœ‰ elï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥
            new Observer(this.$data);
            new Compiler(this.$el, this);
        }
    }
}
```
å¥½åƒå°‘äº†ç‚¹ä»€ä¹ˆï¼Œcomputedã€methods ä¹Ÿéœ€è¦å¤„ç†ï¼Œè¡¥ä¸Šã€‚
``` javascript
class MVVM {
    constructor(options) { // åˆå§‹åŒ–
        // Â·Â·Â· æ¥æ”¶å‚æ•°
        let computed = options.computed;
        let methods = options.methods;
        let that = this;
        if(this.$el){ // å¦‚æœæœ‰ elï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥
        // æŠŠ computed çš„keyå€¼ä»£ç†åˆ° this ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è®¿é—® this.$data.infoï¼Œå–å€¼çš„æ—¶å€™ä¾¿ç›´æ¥è¿è¡Œ è®¡ç®—æ–¹æ³•
            for(let key in computed){
                Object.defineProperty(this.$data, key, {
                    get() {
                        return computed[key].call(that);
                    }
                })
            }
        // æŠŠ methods çš„æ–¹æ³•ç›´æ¥ä»£ç†åˆ° this ä¸Šï¼Œè¿™æ ·å¯ä»¥è®¿é—® this.clear
            for(let key in methods){
                Object.defineProperty(this, key, {
                    get(){
                        return methods[key];
                    }
                })
            }
        }
    }
}
```
ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æŠŠ data æ”¾åˆ°äº† this.$data ä¸Šï¼Œä½†æ˜¯æƒ³æƒ³æˆ‘ä»¬å¹³æ—¶ï¼Œéƒ½æ˜¯ç”¨ this.xxx æ¥è®¿é—®çš„ã€‚æ‰€ä»¥ï¼Œdata ä¹Ÿå’Œè®¡ç®—å±æ€§å®ƒä»¬ä¸€æ ·ï¼Œéœ€è¦åŠ ä¸€å±‚ä»£ç†ï¼Œæ–¹ä¾¿è®¿é—®ã€‚å¯¹äºè®¡ç®—å±æ€§çš„è¯¦ç»†æµç¨‹ï¼Œæˆ‘ä»¬åœ¨æ•°æ®åŠ«æŒçš„æ—¶å€™å†è®²ã€‚
``` javascript
class MVVM {
    constructor(options) { // åˆå§‹åŒ–
        if(this.$el){
            this.proxyData(this.$data);
            // Â·Â·Â· çœç•¥
        }
    }
    proxyData(data) { // æ•°æ®ä»£ç†
        for(let key in data){
           // è®¿é—® this.name å®é™…æ˜¯è®¿é—®çš„ this.$data.name
            Object.defineProperty(this, key, {
                get(){
                    return data[key];
                },
                set(newVal){
                    data[key] = newVal;
                }
            })
        }
    }
}
```
### æ•°æ®åŠ«æŒã€å‘å¸ƒè®¢é˜…
åˆå§‹åŒ–åæˆ‘ä»¬è¿˜å‰©ä¸¤æ­¥æ“ä½œç­‰å¾…å¤„ç†ã€‚
``` javascript
new Observer(this.$data); // æ•°æ®åŠ«æŒ + å‘å¸ƒè®¢é˜…
new Compiler(this.$el, this); // æ¨¡æ¿ç¼–è¯‘
```
æ•°æ®åŠ«æŒå’Œå‘å¸ƒè®¢é˜…ï¼Œæˆ‘ä»¬æ–‡ç« å‰é¢èŠ±äº†å¾ˆé•¿çš„ç¯‡å¹…ä¸€ç›´åœ¨è®²è¿™ä¸ªï¼Œå¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œæ‰€ä»¥å…ˆæŠŠå®ƒå¹²æ‰ã€‚
``` javascript
class Dep { // å‘å¸ƒè®¢é˜…
    constructor(){
        this.subs = []; // watcher è§‚å¯Ÿè€…é›†åˆ
    }
    addSub(watcher){ // æ·»åŠ  watcher
        this.subs.push(watcher);
    }
    notify(){ // å‘å¸ƒ
        this.subs.forEach(w => w.update());
    }
}

class Watcher{ // è§‚å¯Ÿè€…
    constructor(vm, expr, cb){
        this.vm = vm; // å®ä¾‹
        this.expr = expr; // è§‚å¯Ÿæ•°æ®çš„è¡¨è¾¾å¼
        this.cb = cb; // æ›´æ–°è§¦å‘çš„å›è°ƒ
        this.value = this.get(); // ä¿å­˜æ—§å€¼
    }
    get(){ // å–å€¼æ“ä½œï¼Œè§¦å‘æ•°æ® getterï¼Œæ·»åŠ è®¢é˜…
        Dep.target = this; // è®¾ç½®ä¸ºè‡ªèº«
        let value = resolveFn.getValue(this.vm, this.expr); // å–å€¼
        Dep.target = null; // é‡ç½®ä¸º null
        return value;
    }
    update(){ // æ›´æ–°
        let newValue = resolveFn.getValue(this.vm, this.expr);
        if(newValue !== this.value){
            this.cb(newValue);
            this.value = newValue;
        }
    }
}

class Observer{ // æ•°æ®åŠ«æŒ
    constructor(data){
        this.observe(data);
    }
    observe(data){
        if(data && typeof data === 'object') {
            if (Array.isArray(data)) { // å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†è§‚å¯Ÿæ•°ç»„çš„æ¯ä¸ªæˆå‘˜
                data.forEach(v => {
                    this.observe(v);
                });
                // Vue åœ¨è¿™é‡Œè¿˜è¿›è¡Œäº†æ•°ç»„æ–¹æ³•çš„é‡å†™ç­‰ä¸€äº›ç‰¹æ®Šå¤„ç†
                return;
            }
            Object.keys(data).forEach(k => { // è§‚å¯Ÿå¯¹è±¡çš„æ¯ä¸ªå±æ€§
                this.defineReactive(data, k, data[k]);
            });
        }
    }
    defineReactive(obj, key, value) {
        let that = this;
        this.observe(value); //å¯¹è±¡å±æ€§çš„å€¼ï¼Œå¦‚æœæ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œå†æ¬¡è§‚å¯Ÿ
        let dep = new Dep();
        Object.defineProperty(obj, key, {
            get(){ // å–å€¼æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦è¦æ·»åŠ  Watcherï¼Œæ”¶é›†ä¾èµ–
                Dep.target && dep.addSub(Dep.target);
                return value;
            },
            set(newVal){
                if(newVal !== value) {
                    that.observe(newVal); // è§‚å¯Ÿæ–°è®¾ç½®çš„å€¼
                    value = newVal;
                    dep.notify(); // å‘å¸ƒ
                }
            }
        })
    }
}
```
å–å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç”¨åˆ°äº† `resolveFn.getValue` è¿™ä¹ˆä¸€ä¸ªæ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¥å…·æ–¹æ³•çš„é›†åˆï¼Œåç»­ç¼–è¯‘çš„æ—¶å€™è¿˜æœ‰å¾ˆå¤šã€‚æˆ‘ä»¬å…ˆä»”ç»†çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ã€‚
``` javascript
resolveFn = { // å·¥å…·å‡½æ•°é›†
    getValue(vm, expr) { // è¿”å›æŒ‡å®šè¡¨è¾¾å¼çš„æ•°æ®
        return expr.split('.').reduce((data, current)=>{
            return data[current]; // this[info]ã€this[obj][a]
        }, vm);
    }
}
```
æˆ‘ä»¬åœ¨ä¹‹å‰çš„åˆ†æä¸­æåˆ°è¿‡ï¼Œè¡¨è¾¾å¼å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚æ¸²æŸ“å‡½æ•°ï¼‰ï¼Œåªè¦èƒ½è§¦å‘å–å€¼æ“ä½œå³å¯ã€‚æˆ‘ä»¬è¿™é‡Œåªè€ƒè™‘äº†å­—ç¬¦ä¸²çš„å½¢å¼ï¼Œå“ªäº›åœ°æ–¹ä¼šæœ‰è¿™ç§è¡¨è¾¾å¼å‘¢ï¼Ÿæ¯”å¦‚ `{{info}}`ã€æ¯”å¦‚ `v-model="name"`ä¸­ = åé¢çš„å°±æ˜¯è¡¨è¾¾å¼ã€‚å®ƒä¹Ÿæœ‰å¯èƒ½æ˜¯ `obj.a` çš„å½¢å¼ã€‚æ‰€ä»¥è¿™é‡Œåˆ©ç”¨ reduce è¾¾åˆ°ä¸€ä¸ªè¿ç»­å–å€¼çš„æ•ˆæœã€‚

### è®¡ç®—å±æ€§ computed
åˆå§‹åŒ–æ—¶å€™é—ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ¶‰åŠåˆ°å‘å¸ƒè®¢é˜…ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œè¯¦ç»†åˆ†æä¸€ä¸‹è®¡ç®—å±æ€§çš„è§¦å‘æµç¨‹ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ¨¡æ¿ä¸­ç”¨åˆ°äº† `{{info}}`ï¼Œé‚£ä¹ˆåœ¨æ¨¡æ¿ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±éœ€è¦è§¦å‘ä¸€æ¬¡ this.info çš„å–å€¼æ“ä½œè·å–çœŸå®çš„å€¼ç”¨æ¥æ›¿æ¢ `{{info}}` è¿™ä¸ªå­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å°±åŒæ ·åœ¨è¿™ä¸ªåœ°æ–¹æ·»åŠ ä¸€ä¸ªè§‚å¯Ÿè€…ã€‚
``` javascript
    compileText(node, '{{info}}', '') // å‡è®¾ç¼–è¯‘æ–¹æ³•é•¿è¿™æ ·ï¼Œåˆå§‹å€¼ä¸ºç©º
    new Watcher(this, 'info', () => {do something}) // æˆ‘ä»¬ç´§è·Ÿç€å®ä¾‹åŒ–ä¸€ä¸ªè§‚å¯Ÿè€…
```
è¿™ä¸ªæ—¶å€™ä¼šè§¦å‘ä»€ä¹ˆæ“ä½œï¼Ÿæˆ‘ä»¬çŸ¥é“ `new Watcher() ` çš„æ—¶å€™ï¼Œä¼šè§¦å‘ä¸€æ¬¡å–å€¼ã€‚æ ¹æ®åˆšæ‰çš„å–å€¼å‡½æ•°ï¼Œè¿™æ—¶å€™ä¼šå»å– `this.info`ï¼Œè€Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™åˆåšäº†ä»£ç†ã€‚
``` javascript
for(let key in computed){
    Object.defineProperty(this.$data, key, {
        get() {
            return computed[key].call(that);
        }
    })
}
```
æ‰€ä»¥è¿™æ—¶å€™ï¼Œä¼šç›´æ¥è¿è¡Œ computed å®šä¹‰çš„æ–¹æ³•ï¼Œè¿˜è®°å¾—æ–¹æ³•é•¿ä»€ä¹ˆæ ·å—ï¼Ÿ
``` javascript
computed: {
    info() {
        return `æˆ‘å«${this.name}ï¼Œä»Šå¹´${this.ã€age}ï¼Œæ˜¯ä¸€å${this.profession}`;
    }
}
```
äºæ˜¯åˆä¼šæ¥è¿è§¦å‘ nameã€age ä»¥åŠ profession çš„å–å€¼æ“ä½œã€‚
``` javascript
defineReactive(obj, key, value) {
    // Â·Â·Â·
    let dep = new Dep();
    Object.defineProperty(obj, key, {
        get(){ // å–å€¼æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦è¦æ·»åŠ  Watcherï¼Œæ”¶é›†ä¾èµ–
            Dep.target && dep.addSub(Dep.target);
            return value;
        }
        // Â·Â·Â·
    })
}
```
è¿™æ—¶å€™å°±å……åˆ†åˆ©ç”¨äº† **é—­åŒ…** çš„ç‰¹æ€§ï¼Œè¦æ³¨æ„çš„æ˜¯ç°åœ¨ä»ç„¶è¿˜åœ¨ info çš„å–å€¼æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæ˜¯ **åŒæ­¥** æ–¹æ³•ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œç°åœ¨çš„ Dep.target æ˜¯å­˜åœ¨çš„ï¼Œå¹¶ä¸”æ˜¯è§‚å¯Ÿ info å±æ€§çš„ Watcherã€‚æ‰€ä»¥ç¨‹åºä¼šåœ¨ nameã€age å’Œ profession çš„ dep ä¸Šï¼Œåˆ†åˆ«æ·»åŠ ä¸Š info çš„ Watcherï¼Œè¿™æ ·ï¼Œåœ¨è¿™ä¸‰ä¸ªå±æ€§åé¢ä»»æ„ä¸€ä¸ªå€¼å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šé€šçŸ¥ç»™ info çš„ Watcher é‡æ–°å–å€¼å¹¶æ›´æ–°è§†å›¾ã€‚

**æ‰“å°ä¸€ä¸‹æ­¤æ—¶çš„ depï¼Œæ–¹ä¾¿ç†è§£ã€‚**
![](https://user-gold-cdn.xitu.io/2019/4/10/16a030a19f46b487?w=940&h=180&f=png&s=8382)

### æ¨¡æ¿ç¼–è¯‘
å…¶å®å‰é¢å·²ç»æåˆ°äº†ä¸€äº›æ¨¡æ¿ç¼–è¯‘ç›¸å…³çš„ä¸œè¥¿ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸»è¦åšçš„äº‹å°±æ˜¯å°† html ä¸Šçš„æ¨¡æ¿è¯­æ³•ç¼–è¯‘æˆçœŸå®æ•°æ®ï¼Œå°†æŒ‡ä»¤ä¹Ÿè½¬æ¢ä¸ºç›¸å¯¹åº”çš„å‡½æ•°ã€‚

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œé¿å…ä¸äº†è¦æ“ä½œ Dom å…ƒç´ ï¼Œæ‰€ä»¥è¿™é‡Œç”¨äº†ä¸€ä¸ª createDocumentFragment æ–¹æ³•æ¥åˆ›å»ºæ–‡æ¡£ç¢ç‰‡ã€‚è¿™åœ¨ Vue ä¸­å®é™…ä½¿ç”¨çš„æ˜¯è™šæ‹Ÿ domï¼Œè€Œä¸”åœ¨æ›´æ–°çš„æ—¶å€™ç”¨ diff ç®—æ³•æ¥åš **æœ€å°ä»£ä»·æ¸²æŸ“**ã€‚

> æ–‡æ¡£ç‰‡æ®µå­˜åœ¨äºå†…å­˜ä¸­ï¼Œå¹¶ä¸åœ¨DOMæ ‘ä¸­ï¼Œæ‰€ä»¥å°†å­å…ƒç´ æ’å…¥åˆ°æ–‡æ¡£ç‰‡æ®µæ—¶ä¸ä¼šå¼•èµ·é¡µé¢å›æµï¼ˆå¯¹å…ƒç´ ä½ç½®å’Œå‡ ä½•ä¸Šçš„è®¡ç®—ï¼‰ã€‚å› æ­¤ï¼Œä½¿ç”¨æ–‡æ¡£ç‰‡æ®µé€šå¸¸ä¼šå¸¦æ¥æ›´å¥½çš„æ€§èƒ½ã€‚â€” [MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/createDocumentFragment)

``` javascript
class Compiler{
    constructor(el, vm) {
        this.el = this.isElementNode(el) ? el : document.querySelector(el); // è·å–appèŠ‚ç‚¹
        this.vm = vm;
        let fragment = this.createFragment(this.el); // å°† dom è½¬æ¢ä¸ºæ–‡æ¡£ç¢ç‰‡
        this.compile(fragment); // ç¼–è¯‘
        this.el.appendChild(fragment); // å˜æ˜“å®Œæˆåï¼Œé‡æ–°æ”¾å› dom
    }
    createFragment(node) { // å°† dom å…ƒç´ ï¼Œè½¬æ¢æˆæ–‡æ¡£ç‰‡æ®µ
        let fragment = document.createDocumentFragment();
        let firstChild;
        // ä¸€ç›´å»ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å¹¶å°†å…¶æ”¾è¿›æ–‡æ¡£ç¢ç‰‡ï¼Œç›´åˆ°æ²¡æœ‰ï¼Œå–ä¸åˆ°åˆ™åœæ­¢å¾ªç¯
        while(firstChild = node.firstChild) {
            fragment.appendChild(firstChild);
        }
        return fragment;
    }
    isDirective(attrName) { // æ˜¯å¦æ˜¯æŒ‡ä»¤
        return attrName.startsWith('v-');
    }
    isElementNode(node) { // æ˜¯å¦æ˜¯å…ƒç´ èŠ‚ç‚¹
        return node.nodeType === 1;
    }
    compile(node) { // ç¼–è¯‘èŠ‚ç‚¹
        let childNodes = node.childNodes; // è·å–æ‰€æœ‰å­èŠ‚ç‚¹
        [...childNodes].forEach(child => {
            if(this.isElementNode(child)){ // æ˜¯å¦æ˜¯å…ƒç´ èŠ‚ç‚¹
                this.compile(child); // é€’å½’éå†å­èŠ‚ç‚¹
                let attributes = child.attributes; 
                // è·å–å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§ v-model class ç­‰
                [...attributes].forEach(attr => { // ä»¥  v-on:click="clear" ä¸ºä¾‹
                    let {name, value: exp} = attr; // ç»“æ„è·å– "clear"
                    if(this.isDirective(name)) { // åˆ¤æ–­æ˜¯ä¸æ˜¯æŒ‡ä»¤å±æ€§
                        let [, directive] = name.split('-'); // ç»“æ„è·å–æŒ‡ä»¤éƒ¨åˆ† v-on:click
                        let [directiveName, eventName] = directive.split(':'); // onï¼Œclick
                        resolveFn[directiveName](child, exp, this.vm, eventName); 
                        // æ‰§è¡Œç›¸åº”æŒ‡ä»¤æ–¹æ³•
                    }
                })
            }else{ // ç¼–è¯‘æ–‡æœ¬
                let content = child.textContent; // è·å–æ–‡æœ¬èŠ‚ç‚¹
                if(/\{\{(.+?)\}\}/.test(content)) { // åˆ¤æ–­æ˜¯å¦æœ‰æ¨¡æ¿è¯­æ³• {{}}
                    resolveFn.text(child, content, this.vm); // æ›¿æ¢æ–‡æœ¬
                }
            }
        });
    }
}

// æ›¿æ¢æ–‡æœ¬çš„æ–¹æ³•
resolveFn = { // å·¥å…·å‡½æ•°é›†
    text(node, exp, vm) {
        // æƒ°æ€§åŒ¹é…ï¼Œé¿å…è¿ç»­å¤šä¸ªæ¨¡æ¿æ—¶ï¼Œä¼šç›´æ¥å–åˆ°æœ€åä¸€ä¸ªèŠ±æ‹¬å·
        // {{name}} {{age}} ä¸ç”¨æƒ°æ€§åŒ¹é… ä¼šä¸€æ¬¡å–å…¨ "{{name}} {{age}}"
        // æˆ‘ä»¬æœŸæœ›çš„æ˜¯ ["{{name}}", "{{age}}"]
        let reg = /\{\{(.+?)\}\}/;
        let expr = exp.match(reg);
        node.textContent = this.getValue(vm, expr[1]); // ç¼–è¯‘æ—¶è§¦å‘æ›´æ–°è§†å›¾
        new Watcher(vm, expr[1], () => { // setter è§¦å‘å‘å¸ƒ
            node.textContent = this.getValue(vm, expr[1]);
        });
    }
}
```
åœ¨ç¼–è¯‘å…ƒç´ èŠ‚ç‚¹ï¼ˆthis.compile(node)ï¼‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ¤æ–­äº†å…ƒç´ å±æ€§æ˜¯å¦æ˜¯æŒ‡ä»¤ï¼Œå¹¶è°ƒç”¨ç›¸å¯¹åº”çš„æŒ‡ä»¤æ–¹æ³•ã€‚æ‰€ä»¥æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ä¸€äº›æŒ‡ä»¤çš„ç®€å•å®ç°ã€‚
* åŒå‘ç»‘å®š v-model
``` javascript
resolveFn = { // å·¥å…·å‡½æ•°é›†
    setValue(vm, exp, value) {
        exp.split('.').reduce((data, current, index, arr)=>{ // 
            if(index === arr.length-1) { // æœ€åä¸€ä¸ªæˆå‘˜æ—¶ï¼Œè®¾ç½®å€¼
                return data[current] = value;
            }
            return data[current];
        }, vm.$data);
    },
    model(node, exp, vm) {
        new Watcher(vm, exp, (newVal) => { // æ·»åŠ è§‚å¯Ÿè€…ï¼Œæ•°æ®å˜åŒ–ï¼Œæ›´æ–°è§†å›¾
            node.value = newVal;
        });
        node.addEventListener('input', (e) => { //ç›‘å¬ input äº‹ä»¶ï¼ˆè§†å›¾å˜åŒ–ï¼‰ï¼Œäº‹ä»¶è§¦å‘ï¼Œæ›´æ–°æ•°æ®
            let value = e.target.value;
            this.setValue(vm, exp, value); // è®¾ç½®æ–°å€¼
        });
        // ç¼–è¯‘æ—¶è§¦å‘
        let value  = this.getValue(vm, exp);
        node.value = value;
    }
}
```
åŒå‘ç»‘å®šå¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ setValue çš„æ—¶å€™ï¼Œä¸èƒ½ç›´æ¥ç”¨ reduce çš„è¿”å›å€¼å»è®¾ç½®ã€‚å› ä¸ºè¿™ä¸ªæ—¶å€™è¿”å›å€¼ï¼Œåªæ˜¯ä¸€ä¸ªå€¼è€Œå·²ï¼Œè¾¾ä¸åˆ°é‡æ–°èµ‹å€¼çš„ç›®çš„ã€‚
* äº‹ä»¶ç»‘å®š v-on
è¿˜è®°å¾—æˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™æ€ä¹ˆå¤„ç†çš„ methods å—ï¼Ÿ
``` javascript
for(let key in methods){
    Object.defineProperty(this, key, {
        get(){
            return methods[key];
        }
    })
} 
```
æˆ‘ä»¬å°†æ‰€æœ‰çš„ methods éƒ½ä»£ç†åˆ°äº† this ä¸Šï¼Œè€Œä¸”æˆ‘ä»¬åœ¨ç¼–è¯‘ `v-on:click="clear"` çš„æ—¶å€™ï¼Œå°†æŒ‡ä»¤è§£æ„æˆäº† 'on'ã€'click'ã€'clear' ï¼Œé‚£ä¹ˆ on å‡½æ•°çš„å®ç°æ˜¯ä¸æ˜¯å‘¼ä¹‹æ¬²å‡ºäº†å‘¢ï¼Ÿ
``` javascript
on(node, exp, vm, eventName) { // ç›‘å¬å¯¹åº”èŠ‚ç‚¹ä¸Šçš„äº‹ä»¶ï¼Œè§¦å‘æ—¶è°ƒç”¨ç›¸å¯¹åº”çš„ä»£ç†åˆ° this ä¸Šçš„æ–¹æ³•
    node.addEventListener(eventName, e => {
        vm[exp].call(vm, e);
    })
}
```
Vue æä¾›çš„æŒ‡ä»¤è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šv-ifï¼Œå®é™…æ˜¯å°† dom å…ƒç´ æ·»åŠ æˆ–ç§»é™¤çš„æ“ä½œï¼›v-showï¼Œå®é™…æ˜¯æ“ä½œå…ƒç´ çš„ display å±æ€§ä¸º block æˆ–è€… noneï¼›v-htmlï¼Œæ˜¯å°†æŒ‡ä»¤å€¼ç›´æ¥æ·»åŠ ç»™ dom å…ƒç´ ï¼Œå¯ä»¥ç”¨ innerHTML å®ç°ï¼Œä½†æ˜¯è¿™ç§æ“ä½œå¤ªä¸å®‰å…¨ï¼Œæœ‰ xss é£é™©ï¼Œæ‰€ä»¥ Vue ä¹Ÿæ˜¯å»ºè®®ä¸è¦å°†æ¥å£æš´éœ²ç»™ç”¨æˆ·ã€‚è¿˜æœ‰ v-forã€v-slot è¿™ç±»ç›¸å¯¹å¤æ‚äº›çš„æŒ‡ä»¤ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å†æ¢ç©¶ã€‚
## æ€»ç»“
æ–‡ç« å®Œæ•´ä»£ç åœ¨ **æ–‡ç« ä»“åº“ [ğŸ¹ğŸ°fe-code](hhttps://github.com/wuyawei/fe-code/tree/master/vue/mvvm)** ã€‚ æœ¬æœŸä¸»è¦è®²äº† Vue çš„å“åº”å¼åŸç†ï¼ŒåŒ…æ‹¬æ•°æ®åŠ«æŒã€å‘å¸ƒè®¢é˜…ã€Proxy å’Œ `Object.defineProperty` çš„ä¸åŒç‚¹ç­‰ç­‰ï¼Œè¿˜é¡ºå¸¦ç®€å•å†™äº†ä¸ª MVVMã€‚Vue ä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„å‰ç«¯æ¡†æ¶ï¼Œå¯ä¾›æˆ‘ä»¬å­¦ä¹ çš„ç‚¹å¤ªå¤šï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å€¼å¾—æˆ‘ä»¬æ·±ç©¶ã€‚åç»­è¿˜ä¼šå¸¦æ¥ç³»åˆ—çš„ Vueã€javascript ç­‰å‰ç«¯çŸ¥è¯†ç‚¹çš„æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ä¸‹ã€‚
## å‚è€ƒæ–‡ç« 
* [å‰–æVueå®ç°åŸç† - å¦‚ä½•å®ç°åŒå‘ç»‘å®šmvvm](https://github.com/DMQ/mvvm)
* [Vue æºç åˆ†æ](https://github.com/HcySunYang/vue-design)
* **å…³äºæ­£åˆ™ï¼Œæ¨èè€å§šçš„[ã€Šè€å§š - JavaScriptæ­£åˆ™è¿·ä½ ä¹¦ã€‹](https://zhuanlan.zhihu.com/p/29707385)ï¼Œè®²å¾—éå¸¸æ˜“è¯»**
## äº¤æµç¾¤
> qqå‰ç«¯äº¤æµç¾¤ï¼š960807765ï¼Œæ¬¢è¿å„ç§æŠ€æœ¯äº¤æµï¼ŒæœŸå¾…ä½ çš„åŠ å…¥

## åè®°
  å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œï¼Œä¸”æœ¬æ–‡å¯¹ä½ æœ‰ä¸€ç‚¹å¸®åŠ©çš„è¯ï¼Œå¸Œæœ›ä½ å¯ä»¥åŠ¨åŠ¨å°æ‰‹æ”¯æŒä¸€ä¸‹ä½œè€…ï¼Œæ„Ÿè°¢ğŸ»ã€‚æ–‡ä¸­å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æŒ‡å‡ºï¼Œå…±å‹‰ã€‚

* **æ–‡ç« ä»“åº“** [ğŸ¹ğŸ°fe-code](https://github.com/wuyawei/fe-code)
* **[ç¤¾äº¤èŠå¤©ç³»ç»Ÿï¼ˆvue + node + mongodbï¼‰- ğŸ’˜ğŸ¦ğŸ™ˆVchat](https://github.com/wuyawei/Vchat)**

æ›´å¤šæ–‡ç« ï¼š

**å‰ç«¯è¿›é˜¶ä¹‹è·¯ç³»åˆ—**

* [ã€2019 å‰ç«¯è¿›é˜¶ä¹‹è·¯ã€‘Vue ç»„ä»¶é—´é€šä¿¡æ–¹å¼å®Œæ•´ç‰ˆ](https://juejin.im/post/5c7b524ee51d453ee81877a7)
* [ã€2019 å‰ç«¯è¿›é˜¶ä¹‹è·¯ã€‘JavaScript åŸå‹å’ŒåŸå‹é“¾åŠ canvas éªŒè¯ç å®è·µ](https://juejin.im/post/5c7b524ee51d453ee81877a7)
* [ã€2019 å‰ç«¯è¿›é˜¶ä¹‹è·¯ã€‘ç«™ä½ï¼Œä½ è¿™ä¸ªPromiseï¼](https://juejin.im/post/5c179aad5188256d9832fb61)

**ä»å¤´åˆ°è„šå®æˆ˜ç³»åˆ—**

* [ã€ä»å¤´åˆ°è„šã€‘WebRTC + Canvas å®ç°ä¸€ä¸ªåŒäººåä½œçš„å…±äº«ç”»æ¿ | æ˜é‡‘æŠ€æœ¯å¾æ–‡](https://juejin.im/post/5c9cbbb85188251c3a2f36e8)
* [ã€ä»å¤´åˆ°è„šã€‘æ’¸ä¸€ä¸ªå¤šäººè§†é¢‘èŠå¤© â€” å‰ç«¯ WebRTC å®æˆ˜ï¼ˆä¸€ï¼‰](https://juejin.im/post/5c3acfa56fb9a049f36254be)
* [ã€ä»å¤´åˆ°è„šã€‘æ’¸ä¸€ä¸ªç¤¾äº¤èŠå¤©ç³»ç»Ÿï¼ˆvue + node + mongodbï¼‰- ğŸ’˜ğŸ¦ğŸ™ˆVchat ](https://juejin.im/post/5c0a00fb6fb9a049d4419d3a)

æ¬¢è¿å…³æ³¨å…¬ä¼—å· **å‰ç«¯å‘åŠ¨æœº**ï¼Œç¬¬ä¸€æ—¶é—´è·å¾—ä½œè€…æ–‡ç« æ¨é€ï¼Œè¿˜æœ‰æµ·é‡å‰ç«¯å¤§ä½¬ä¼˜è´¨æ–‡ç« ï¼Œè‡´åŠ›äºæˆä¸ºæ¨åŠ¨å‰ç«¯æˆé•¿çš„å¼•æ“ã€‚
  
![](https://user-gold-cdn.xitu.io/2019/3/16/1698668bd914d63f?w=258&h=258&f=jpeg&s=27979)