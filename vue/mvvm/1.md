## å‰è¨€
ä½œä¸º Vue é¢è¯•ä¸­çš„å¿…è€ƒé¢˜ä¹‹ä¸€ï¼ŒVue çš„å“åº”å¼åŸç†ï¼Œæƒ³å¿…ç”¨è¿‡ Vue çš„åŒå­¦éƒ½ä¸ä¼šé™Œç”Ÿï¼Œ[Vue å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/reactivity.html) å¯¹å“åº”å¼è¦æ³¨æ„çš„é—®é¢˜ä¹Ÿéƒ½åšäº†è¯¦ç»†çš„è¯´æ˜ã€‚

ä½†æ˜¯å¯¹äºåˆšæ¥è§¦æˆ–è€…äº†è§£ä¸å¤šçš„åŒå­¦æ¥è¯´ï¼Œå¯èƒ½è¿˜ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼šä¸ºä»€ä¹ˆä¸èƒ½æ£€æµ‹åˆ°å¯¹è±¡å±æ€§çš„æ·»åŠ æˆ–åˆ é™¤ï¼Ÿä¸ºä»€ä¹ˆä¸æ”¯æŒé€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„æˆå‘˜ï¼Ÿç›¸ä¿¡çœ‹å®Œæœ¬æœŸæ–‡ç« ï¼Œä½ ä¸€å®šä¼šè±ç„¶å¼€æœ—ã€‚

æœ¬æ–‡ä¼šç»“åˆ Vue æºç ï¼Œé’ˆå¯¹æ•´ä¸ªå“åº”å¼åŸç†ä¸€æ­¥æ­¥æ·±å…¥ï¼Œè¿™æ ·å°±ç®—æ˜¯åˆšæ¥è§¦çš„åŒå­¦ä¹Ÿèƒ½è·Ÿä¸‹æ¥ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å·²ç»å¯¹å“åº”å¼åŸç†æœ‰ä¸€äº›è®¤è¯†å’Œäº†è§£ï¼Œå¤§å¯ä»¥ **ç›´æ¥å‰å¾€å®ç°éƒ¨åˆ† [MVVM](#MVVM)**

**æ–‡ç« ä»“åº“å’Œæºç éƒ½åœ¨ [ğŸ¹ğŸ° fe-code](https://github.com/wuyawei/fe-code)ï¼Œæ¬¢è¿ star**ã€‚

Vue å®˜æ–¹çš„å“åº”å¼åŸç†å›¾é•‡æ¥¼ã€‚

![](https://user-gold-cdn.xitu.io/2019/4/2/169deafe6c899320?w=1200&h=750&f=png&s=21308)
## æ€è€ƒ
è¿›å…¥ä¸»é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒå¦‚ä¸‹ä»£ç ã€‚
``` html
<template>
    <div>
        <ul>
            <li v-for="(v, i) in list" :key="i">{{v.text}}</li>
        </ul>
    </div>
</template>
<script>
    export default{
        name: 'responsive',
        data() {
            return {
                list: []
            }
        },
        mounted() {
            setTimeout(_ => {
                this.list = [{text: 666}, {text: 666}, {text: 666}];
            },1000);
            setTimeout(_ => {
                this.list.forEach((v, i) => { v.text = i; });
            },2000)
        }
    }
</script>
```
æˆ‘ä»¬çŸ¥é“åœ¨ Vue ä¸­ï¼Œä¼šé€šè¿‡ `Object.defineProperty` å°† data ä¸­å®šä¹‰çš„å±æ€§åšæ•°æ®åŠ«æŒï¼Œç”¨æ¥æ”¯æŒç›¸å…³æ“ä½œçš„å‘å¸ƒè®¢é˜…ã€‚è€Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œdata ä¸­åªå®šä¹‰äº† list ä¸ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œæ‰€ä»¥ Vue ä¼šå¯¹å®ƒè¿›è¡ŒåŠ«æŒï¼Œå¹¶æ·»åŠ å¯¹åº”çš„ getter/setterã€‚

æ‰€ä»¥åœ¨ 1 s çš„æ—¶å€™ï¼Œé€šè¿‡ `this.list = [{text: 666}, {text: 666}, {text: 666}]` ç»™ list é‡æ–°èµ‹å€¼ï¼Œä¾¿ä¼šè§¦å‘ setterï¼Œè¿›è€Œé€šçŸ¥å¯¹åº”çš„è§‚å¯Ÿè€…ï¼ˆè¿™é‡Œçš„è§‚å¯Ÿè€…æ˜¯æ¨¡æ¿ç¼–è¯‘ï¼‰åšæ›´æ–°ã€‚

åœ¨ 2 s çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆé€šè¿‡æ•°ç»„éå†ï¼Œæ”¹å˜äº†æ¯ä¸€ä¸ª list æˆå‘˜çš„ text å±æ€§ï¼Œè§†å›¾å†æ¬¡æ›´æ–°ã€‚è¿™ä¸ªåœ°æ–¹éœ€è¦å¼•èµ·æˆ‘ä»¬çš„æ³¨æ„ï¼Œå¦‚æœåœ¨å¾ªç¯ä½“å†…ç›´æ¥ç”¨ `this.list[i] = {text: i}` æ¥åšæ•°æ®æ›´æ–°æ“ä½œï¼Œæ•°æ®å¯ä»¥æ­£å¸¸æ›´æ–°ï¼Œä½†æ˜¯è§†å›¾ä¸ä¼šã€‚è¿™ä¹Ÿæ˜¯å‰é¢æåˆ°çš„ï¼Œä¸æ”¯æŒé€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„æˆå‘˜ã€‚

ä½†æ˜¯æˆ‘ä»¬ç”¨ `v.text = i` è¿™æ ·çš„æ–¹å¼ï¼Œè§†å›¾å´èƒ½æ­£å¸¸æ›´æ–°ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼ŸæŒ‰ç…§ä¹‹å‰è¯´çš„ï¼ŒVue ä¼šåŠ«æŒ data é‡Œçš„å±æ€§ï¼Œå¯æ˜¯ list å†…éƒ¨æˆå‘˜çš„å±æ€§ï¼Œæ˜æ˜æ²¡æœ‰è¿›è¡Œæ•°æ®åŠ«æŒå•Šï¼Œä¸ºä»€ä¹ˆä¹Ÿèƒ½æ›´æ–°è§†å›¾å‘¢ï¼Ÿ 

è¿™æ˜¯å› ä¸ºåœ¨ç»™ list åš setter æ“ä½œæ—¶ï¼Œä¼šå…ˆåˆ¤æ–­èµ‹çš„æ–°å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡çš„è¯ä¼šå†æ¬¡è¿›è¡ŒåŠ«æŒï¼Œå¹¶æ·»åŠ å’Œ list ä¸€æ ·çš„è§‚å¯Ÿè€…ã€‚

æˆ‘ä»¬æŠŠä»£ç å†ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼š
``` html
// è§†å›¾å¢åŠ äº† v-if çš„æ¡ä»¶åˆ¤æ–­
<ul>
    <li v-for="(v, i) in list" :key="i" v-if="v.status === '1'">{{v.text}}</li>
</ul>

// 2 s æ—¶ï¼Œæ–°å¢çŠ¶æ€å±æ€§ã€‚
mounted() {
    setTimeout(_ => {
        this.list = [{text: 666}, {text: 666}, {text: 666}];
    },1000);
    setTimeout(_ => {
        this.list.forEach((v, i) => {
            v.text = i;
            v.status = '1'; // æ–°å¢çŠ¶æ€
        });
    },2000)
}
```
å¦‚ä¸Šï¼Œæˆ‘ä»¬åœ¨è§†å›¾å¢åŠ äº† v-if çš„çŠ¶æ€åˆ¤æ–­ï¼Œåœ¨ 2 s çš„æ—¶å€™ï¼Œè®¾ç½®äº†çŠ¶æ€ã€‚ä½†æ˜¯äº‹ä¸æ„¿è¿ï¼Œè§†å›¾å¹¶ä¸ä¼šåƒæˆ‘ä»¬æœŸå¾…çš„é‚£æ ·åœ¨ 2 s çš„æ—¶å€™ç›´æ¥æ˜¾ç¤º 0ã€1ã€2ï¼Œè€Œæ˜¯ä¸€ç›´æ˜¯ç©ºç™½çš„ã€‚

è¿™æ˜¯å¾ˆå¤šæ–°æ‰‹æ˜“çŠ¯çš„é”™è¯¯ï¼Œå› ä¸ºç»å¸¸ä¼šæœ‰ç±»ä¼¼çš„éœ€æ±‚ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ Vue ä¸èƒ½æ£€æµ‹åˆ°å¯¹è±¡å±æ€§çš„æ·»åŠ æˆ–åˆ é™¤ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¾¾åˆ°é¢„æœŸçš„æ•ˆæœè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¾ˆç®€å•ï¼š
``` javascript
// åœ¨ 1 s è¿›è¡Œèµ‹å€¼æ“ä½œæ—¶ï¼Œé¢„ç½® status å±æ€§ã€‚
setTimeout(_ => {
    this.list = [{text: 666, status: '0'}, {text: 666, status: '0'}, {text: 666, status: '0'}];
},1000);
```
å½“ç„¶ Vue ä¹Ÿ æä¾›äº† `vm.$set( target, key, value )` æ–¹æ³•æ¥è§£å†³ç‰¹å®šæƒ…å†µä¸‹æ·»åŠ å±æ€§çš„æ“ä½œï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¸å¤ªé€‚ç”¨ã€‚
## Vue å“åº”å¼åŸç†
å‰é¢æˆ‘ä»¬è®²äº†ä¸¤ä¸ªå…·ä½“ä¾‹å­ï¼Œä¸¾äº†æ˜“çŠ¯çš„é”™è¯¯ä»¥åŠè§£å†³åŠæ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¾ç„¶åªçŸ¥é“åº”è¯¥è¿™ä¹ˆå»åšï¼Œè€Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå»åšã€‚

Vue çš„æ•°æ®åŠ«æŒä¾èµ–äº `Object.defineProperty`ï¼Œæ‰€ä»¥ä¹Ÿæ­£æ˜¯å› ä¸ºå®ƒçš„æŸäº›ç‰¹æ€§ï¼Œæ‰å¼•èµ·è¿™ä¸ªé—®é¢˜ã€‚ä¸äº†è§£è¿™ä¸ªå±æ€§çš„åŒå­¦çœ‹è¿™é‡Œ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)ã€‚
### Object.defineProperty åŸºç¡€å®ç°
> Object.defineProperty() æ–¹æ³•ä¼šç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œ å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚â€” MDN

çœ‹ä¸€ä¸ªåŸºç¡€çš„æ•°æ®åŠ«æŒçš„æ —å­ï¼Œè¿™ä¹Ÿæ˜¯å“åº”å¼æœ€æ ¹æœ¬çš„ä¾èµ–ã€‚
``` javascript
function defineReactive(obj, key, val) {
    Object.defineProperty(obj, key, {
        enumerable: true, // å¯æšä¸¾
        configurable: true, // å¯å†™
        get: function() {
            console.log('get');
            return val;
        },
        set: function(newVal) {
            // è®¾ç½®æ—¶ï¼Œå¯ä»¥æ·»åŠ ç›¸åº”çš„æ“ä½œ
            console.log('set');
            val += newVal;
        }
    });
}
let obj = {name: 'æˆé¾™å¤§å“¥', say: 'ï¼šå…¶å®æˆ‘ä¹‹å‰æ˜¯æ‹’ç»æ‹è¿™ä¸ªæ¸¸æˆå¹¿å‘Šçš„ï¼Œ'};
Object.keys(obj).forEach(k => {
    defineReactive(obj, k, obj[k]);
});
obj.say = 'åæ¥æˆ‘è¯•ç©äº†ä¸€ä¸‹ï¼Œå“‡ï¼Œå¥½çƒ­è¡€ï¼Œè›®å¥½ç©çš„';
console.log(obj.name + obj.say);
// æˆé¾™å¤§å“¥ï¼šå…¶å®æˆ‘ä¹‹å‰æ˜¯æ‹’ç»æ‹è¿™ä¸ªæ¸¸æˆå¹¿å‘Šçš„ï¼Œåæ¥æˆ‘è¯•ç©äº†ä¸€ä¸‹ï¼Œå“‡ï¼Œå¥½çƒ­è¡€ï¼Œè›®å¥½ç©çš„
```
å¯ä»¥çœ‹è§ï¼Œ`Object.defineProperty` æ˜¯å¯¹å·²æœ‰å±æ€§è¿›è¡Œçš„åŠ«æŒæ“ä½œï¼Œæ‰€ä»¥ Vue æ‰è¦æ±‚äº‹å…ˆå°†éœ€è¦ç”¨åˆ°çš„æ•°æ®å®šä¹‰åœ¨ data ä¸­ï¼ŒåŒæ—¶ä¹Ÿæ— æ³•å“åº”å¯¹è±¡å±æ€§çš„æ·»åŠ å’Œåˆ é™¤ã€‚è¢«åŠ«æŒçš„å±æ€§ä¼šæœ‰ç›¸åº”çš„ getã€set æ–¹æ³•ã€‚

![](https://user-gold-cdn.xitu.io/2019/4/6/169f32eaaa3f173c?w=270&h=208&f=png&s=3426)

å¦å¤–ï¼Œ[Vue å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/v2/guide/list.html#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9) ä¸Šè¯´ï¼šç”±äº JavaScript çš„é™åˆ¶ï¼ŒVue ä¸æ”¯æŒé€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„æˆå‘˜ã€‚å¯¹äºè¿™ä¸€ç‚¹ï¼Œå…¶å®ç›´æ¥é€šè¿‡ä¸‹æ ‡æ¥å¯¹æ•°ç»„è¿›è¡ŒåŠ«æŒï¼Œæ˜¯å¯ä»¥åšåˆ°çš„ã€‚
``` javascript
let arr = [1,2,3,4,5];
arr.forEach((v, i) => { // é€šè¿‡ä¸‹æ ‡è¿›è¡ŒåŠ«æŒ
    defineReactive(arr, i, v);
});
arr[0] = 'oh nanana'; // set
```
é‚£ä¹ˆ Vue ä¸ºä»€ä¹ˆä¸è¿™ä¹ˆå¤„ç†å‘¢ï¼Ÿå°¤å¤§å®˜æ–¹å›ç­”æ˜¯æ€§èƒ½é—®é¢˜ã€‚å…³äºè¿™ä¸ªç‚¹æ›´è¯¦ç»†çš„åˆ†æï¼Œå„ä½å¯ä»¥ç§»æ­¥ [Vueä¸ºä»€ä¹ˆä¸èƒ½æ£€æµ‹æ•°ç»„å˜åŠ¨ï¼Ÿ](https://segmentfault.com/a/1190000015783546)
### Vue æºç å®ç°
> ä»¥ä¸‹ä»£ç  Vue ç‰ˆæœ¬ä¸ºï¼š2.6.10ã€‚

#### observer
æˆ‘ä»¬çŸ¥é“äº†æ•°æ®åŠ«æŒçš„åŸºç¡€å®ç°ï¼Œé¡ºä¾¿å†çœ‹çœ‹ Vue æºç æ˜¯å¦‚ä½•åšçš„ã€‚
``` javascript
// observer/index.js
// Observer å‰çš„é¢„å¤„ç†æ–¹æ³•
export function observe (value: any, asRootData: ?boolean): Observer | void {
  if (!isObject(value) || value instanceof VNode) { // æ˜¯å¦æ˜¯å¯¹è±¡æˆ–è€…è™šæ‹Ÿdom
    return
  }
  let ob: Observer | void
  // åˆ¤æ–­æ˜¯å¦æœ‰ __ob__ å±æ€§ï¼Œæœ‰çš„è¯ä»£è¡¨æœ‰ Observer å®ä¾‹ï¼Œç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å°±åˆ›å»º Observer
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    ob = value.__ob__
  } else if ( // åˆ¤æ–­æ˜¯å¦æ˜¯å•çº¯çš„å¯¹è±¡
    shouldObserve &&
    !isServerRendering() &&
    (Array.isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value._isVue
  ) {
    ob = new Observer(value) // åˆ›å»ºObserver
  }
  if (asRootData && ob) {
    ob.vmCount++
  }
  return ob
}

// Observer å®ä¾‹
export class Observer { 
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that have this object as root $data

  constructor (value: any) {
    this.value = value
    this.dep = new Dep() // ç»™ Observer æ·»åŠ  Dep å®ä¾‹ï¼Œç”¨äºæ”¶é›†ä¾èµ–ï¼Œè¾…åŠ© vm.$set/æ•°ç»„æ–¹æ³•ç­‰
    this.vmCount = 0
    // ä¸ºè¢«åŠ«æŒçš„å¯¹è±¡æ·»åŠ __ob__å±æ€§ï¼ŒæŒ‡å‘è‡ªèº« Observer å®ä¾‹ã€‚ä½œä¸ºæ˜¯å¦ Observer çš„å”¯ä¸€æ ‡è¯†ã€‚
    def(value, '__ob__', this)
    if (Array.isArray(value)) { // åˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„
      if (hasProto) { // åˆ¤æ–­æ˜¯å¦æ”¯æŒ__proto__å±æ€§ï¼Œç”¨æ¥å¤„ç†æ•°ç»„æ–¹æ³•
        protoAugment(value, arrayMethods) // ç»§æ‰¿
      } else {
        copyAugment(value, arrayMethods, arrayKeys) // æ‹·è´
      }
      this.observeArray(value) // åŠ«æŒæ•°ç»„æˆå‘˜
    } else {
      this.walk(value) // åŠ«æŒå¯¹è±¡
    }
  }

  walk (obj: Object) { // åªæœ‰åœ¨å€¼æ˜¯ Object çš„æ—¶å€™ï¼Œæ‰ç”¨æ­¤æ–¹æ³•
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i]) // æ•°æ®åŠ«æŒæ–¹æ³•
    }
  }

  observeArray (items: Array<any>) { // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™è°ƒç”¨ observe å¤„ç†æ•°ç»„æˆå‘˜
    for (let i = 0, l = items.length; i < l; i++) {
      observe(items[i]) // ä¾æ¬¡å¤„ç†æ•°ç»„æˆå‘˜
    }
  }
}
```
ä¸Šé¢éœ€è¦æ³¨æ„çš„æ˜¯ `__ob__` å±æ€§ï¼Œé¿å…é‡å¤åˆ›å»ºï¼Œ`__ob__`ä¸Šæœ‰ä¸€ä¸ª dep å±æ€§ï¼Œä½œä¸ºä¾èµ–æ”¶é›†çš„å‚¨å­˜å™¨ï¼Œåœ¨ vm.$setã€æ•°ç»„çš„ push ç­‰å¤šç§æ–¹æ³•ä¸Šéœ€è¦ç”¨åˆ°ã€‚ç„¶å Vue å°†å¯¹è±¡å’Œæ•°ç»„åˆ†å¼€å¤„ç†ï¼Œæ•°ç»„åªæ·±åº¦ç›‘å¬äº†å¯¹è±¡æˆå‘˜ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹å‰è¯´çš„å¯¼è‡´ä¸èƒ½ç›´æ¥æ“ä½œç´¢å¼•çš„åŸå› ã€‚ä½†æ˜¯æ•°ç»„çš„ä¸€äº›æ–¹æ³•æ˜¯å¯ä»¥æ­£å¸¸å“åº”çš„ï¼Œæ¯”å¦‚ pushã€pop ç­‰ï¼Œè¿™ä¾¿æ˜¯å› ä¸ºä¸Šè¿°åˆ¤æ–­å“åº”å¯¹è±¡æ˜¯å¦æ˜¯æ•°ç»„æ—¶ï¼Œåšçš„å¤„ç†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“ä»£ç ã€‚
``` javascript
// observer/index.js
import { arrayMethods } from './array'
const arrayKeys = Object.getOwnPropertyNames(arrayMethods)

// export function observe çœç•¥éƒ¨åˆ†ä»£ç 
if (Array.isArray(value)) { // åˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„
  if (hasProto) { // åˆ¤æ–­æ˜¯å¦æ”¯æŒ__proto__å±æ€§ï¼Œç”¨æ¥å¤„ç†æ•°ç»„æ–¹æ³•
    protoAugment(value, arrayMethods) // ç»§æ‰¿
  } else {
    copyAugment(value, arrayMethods, arrayKeys) // æ‹·è´
  }
  this.observeArray(value) // åŠ«æŒæ•°ç»„æˆå‘˜
}
// Â·Â·Â·

// ç›´æ¥ç»§æ‰¿ arrayMethods
function protoAugment (target, src: Object) { 
  target.__proto__ = src
}
// ä¾æ¬¡æ‹·è´æ•°ç»„æ–¹æ³•
function copyAugment (target: Object, src: Object, keys: Array<string>) {
  for (let i = 0, l = keys.length; i < l; i++) {
    const key = keys[i]
    def(target, key, src[key])
  }
}

// util/lang.js  def æ–¹æ³•é•¿è¿™æ ·ï¼Œç”¨æ¥ç»™å¯¹è±¡æ·»åŠ å±æ€§
export function def (obj: Object, key: string, val: any, enumerable?: boolean) {
  Object.defineProperty(obj, key, {
    value: val,
    enumerable: !!enumerable,
    writable: true,
    configurable: true
  })
}
```
å¯ä»¥çœ‹åˆ°å…³é”®ç‚¹åœ¨ `arrayMethods`ä¸Šï¼Œæˆ‘ä»¬å†ç»§ç»­çœ‹ï¼š
``` javascript
// observer/array.js
import { def } from '../util/index'

const arrayProto = Array.prototype // å­˜å‚¨æ•°ç»„åŸå‹ä¸Šçš„æ–¹æ³•
export const arrayMethods = Object.create(arrayProto) // åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œé¿å…ç›´æ¥æ”¹å˜æ•°ç»„åŸå‹æ–¹æ³•

const methodsToPatch = [
  'push',
  'pop',
  'shift',
  'unshift',
  'splice',
  'sort',
  'reverse'
]

// é‡å†™ä¸Šè¿°æ•°ç»„æ–¹æ³•
methodsToPatch.forEach(function (method) {
  const original = arrayProto[method]
  def(arrayMethods, method, function mutator (...args) { // 
    const result = original.apply(this, args) // æ‰§è¡ŒæŒ‡å®šæ–¹æ³•
    const ob = this.__ob__ // æ‹¿åˆ°è¯¥æ•°ç»„çš„ ob å®ä¾‹
    let inserted
    switch (method) {
      case 'push':
      case 'unshift':
        inserted = args
        break
      case 'splice':
        inserted = args.slice(2) // splice æ¥æ”¶çš„å‰ä¸¤ä¸ªå‚æ•°æ˜¯ä¸‹æ ‡
        break
    }
    if (inserted) ob.observeArray(inserted) // åŸæ•°ç»„çš„æ–°å¢éƒ¨åˆ†éœ€è¦é‡æ–° observe
    // notify change
    ob.dep.notify() // æ‰‹åŠ¨å‘å¸ƒï¼Œåˆ©ç”¨__ob__ çš„ dep å®ä¾‹
    return result
  })
})
```
ç”±æ­¤å¯è§ï¼ŒVue é‡å†™äº†éƒ¨åˆ†æ•°ç»„æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œåšäº†æ‰‹åŠ¨å‘å¸ƒã€‚ä½†æ˜¯ Vue çš„æ•°æ®åŠ«æŒéƒ¨åˆ†æˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°ï¼Œåœ¨ç¬¬ä¸€éƒ¨åˆ†çš„ observer å‡½æ•°çš„ä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ª defineReactive æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š
``` javascript
export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  const dep = new Dep() // å®ä¾‹ä¸€ä¸ª Dep å®ä¾‹

  const property = Object.getOwnPropertyDescriptor(obj, key) // è·å–å¯¹è±¡è‡ªèº«å±æ€§
  if (property && property.configurable === false) { // æ²¡æœ‰å±æ€§æˆ–è€…å±æ€§ä¸å¯å†™å°±æ²¡å¿…è¦åŠ«æŒäº†
    return
  }

  // å…¼å®¹é¢„å®šä¹‰çš„ getter/setter
  const getter = property && property.get
  const setter = property && property.set
  if ((!getter || setter) && arguments.length === 2) { // åˆå§‹åŒ– val
    val = obj[key]
  }
  // é»˜è®¤ç›‘å¬å­å¯¹è±¡ï¼Œä» observe å¼€å§‹ï¼Œè¿”å› __ob__ å±æ€§ å³ Observer å®ä¾‹
  let childOb = !shallow && observe(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      const value = getter ? getter.call(obj) : val // æ‰§è¡Œé¢„è®¾çš„getterè·å–å€¼
      if (Dep.target) { // ä¾èµ–æ”¶é›†çš„å…³é”®
        dep.depend() // ä¾èµ–æ”¶é›†ï¼Œåˆ©ç”¨äº†å‡½æ•°é—­åŒ…çš„ç‰¹æ€§
        if (childOb) { // å¦‚æœæœ‰å­å¯¹è±¡ï¼Œåˆ™æ·»åŠ åŒæ ·çš„ä¾èµ–
          childOb.dep.depend() // å³ Observeræ—¶çš„ this.dep = new Dep();
          if (Array.isArray(value)) { // value æ˜¯æ•°ç»„çš„è¯è°ƒç”¨æ•°ç»„çš„æ–¹æ³•
            dependArray(value)
          }
        }
      }
      return value
    },
    set: function reactiveSetter (newVal) {
      const value = getter ? getter.call(obj) : val
      // åŸæœ‰å€¼å’Œæ–°å€¼æ¯”è¾ƒï¼Œå€¼ä¸€æ ·åˆ™ä¸åšå¤„ç†
      // newVal !== newVal && value !== value è¿™ä¸ªæ¯”è¾ƒæœ‰æ„æ€ï¼Œä½†å…¶å®æ˜¯ä¸ºäº†å¤„ç† NaN
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      if (process.env.NODE_ENV !== 'production' && customSetter) {
        customSetter()
      }
      if (getter && !setter) return
      if (setter) { // æ‰§è¡Œé¢„è®¾setter
        setter.call(obj, newVal)
      } else { // æ²¡æœ‰é¢„è®¾ç›´æ¥èµ‹å€¼
        val = newVal
      }
      childOb = !shallow && observe(newVal) // æ˜¯å¦è¦è§‚å¯Ÿæ–°è®¾ç½®çš„å€¼
      dep.notify() // å‘å¸ƒï¼Œåˆ©ç”¨äº†å‡½æ•°é—­åŒ…çš„ç‰¹æ€§
    }
  })
}
// å¤„ç†æ•°ç»„
function dependArray (value: Array<any>) {
  for (let e, i = 0, l = value.length; i < l; i++) {
    e = value[i]
    e && e.__ob__ && e.__ob__.dep.depend() // å¦‚æœæ•°ç»„æˆå‘˜æœ‰ __ob__ï¼Œåˆ™æ·»åŠ ä¾èµ–
    if (Array.isArray(e)) { // æ•°ç»„æˆå‘˜è¿˜æ˜¯æ•°ç»„ï¼Œé€’å½’è°ƒç”¨
      dependArray(e)
    }
  }
}
```
#### Dep
åœ¨ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¼„æ‡‚äº† Vue çš„æ•°æ®åŠ«æŒä»¥åŠæ•°ç»„æ–¹æ³•é‡å†™ï¼Œä½†æ˜¯åˆæœ‰äº†æ–°çš„ç–‘æƒ‘ï¼ŒDep æ˜¯åšä»€ä¹ˆçš„ï¼ŸDep æ˜¯ä¸€ä¸ªå‘å¸ƒè€…ï¼Œå¯ä»¥è¢«å¤šä¸ªè§‚å¯Ÿè€…è®¢é˜…ã€‚
``` javascript
// observer/dep.js

let uid = 0
export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array<Watcher>;

  constructor () {
    this.id = uid++ // å”¯ä¸€id
    this.subs = [] // è§‚å¯Ÿè€…é›†åˆ
  }
 // æ·»åŠ è§‚å¯Ÿè€…
  addSub (sub: Watcher) {
    this.subs.push(sub)
  }
 // ç§»é™¤è§‚å¯Ÿè€…
  removeSub (sub: Watcher) {
    remove(this.subs, sub)
  }
  
  depend () { // æ ¸å¿ƒï¼Œå¦‚æœå­˜åœ¨ Dep.targetï¼Œåˆ™è¿›è¡Œä¾èµ–æ”¶é›†æ“ä½œ
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    const subs = this.subs.slice() // é¿å…æ±¡æŸ“åŸæ¥çš„é›†åˆ
    // å¦‚æœä¸æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œå…ˆè¿›è¡Œæ’åºï¼Œä¿è¯è§‚å¯Ÿè€…æ‰§è¡Œé¡ºåº
    if (process.env.NODE_ENV !== 'production' && !config.async) {
      subs.sort((a, b) => a.id - b.id)
    }
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update() // å‘å¸ƒæ‰§è¡Œ
    }
  }
}

Dep.target = null // æ ¸å¿ƒï¼Œç”¨äºé—­åŒ…æ—¶ï¼Œä¿å­˜ç‰¹å®šçš„å€¼
const targetStack = []
// ç»™ Dep.target èµ‹å€¼å½“å‰Watcherï¼Œå¹¶æ·»åŠ è¿›targetæ ˆ
export function pushTarget (target: ?Watcher) {
  targetStack.push(target)
  Dep.target = target
}
// ç§»é™¤æœ€åä¸€ä¸ªWatcherï¼Œå¹¶å°†å‰©ä½™targetæ ˆçš„æœ€åä¸€ä¸ªèµ‹å€¼ç»™ Dep.target
export function popTarget () {
  targetStack.pop()
  Dep.target = targetStack[targetStack.length - 1]
}
```
#### Watcher
å•ä¸ªçœ‹ Dep å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘ä»¬ç»“åˆ Watcher ä¸€èµ·æ¥çœ‹ã€‚
``` javascript
// observer/watcher.js

let uid = 0
export default class Watcher {
  // ...
  constructor (
    vm: Component, // ç»„ä»¶å®ä¾‹å¯¹è±¡
    expOrFn: string | Function, // è¦è§‚å¯Ÿçš„è¡¨è¾¾å¼ï¼Œå‡½æ•°ï¼Œæˆ–è€…å­—ç¬¦ä¸²ï¼Œåªè¦èƒ½è§¦å‘å–å€¼æ“ä½œ
    cb: Function, // è¢«è§‚å¯Ÿè€…å‘ç”Ÿå˜åŒ–åçš„å›è°ƒ
    options?: ?Object, // å‚æ•°
    isRenderWatcher?: boolean // æ˜¯å¦æ˜¯æ¸²æŸ“å‡½æ•°çš„è§‚å¯Ÿè€…
  ) {
    this.vm = vm // Watcheræœ‰ä¸€ä¸ª vm å±æ€§ï¼Œè¡¨æ˜å®ƒæ˜¯å±äºå“ªä¸ªç»„ä»¶çš„
    if (isRenderWatcher) {
      vm._watcher = this
    }
    vm._watchers.push(this) // ç»™ç»„ä»¶å®ä¾‹çš„_watcherså±æ€§æ·»åŠ è§‚å¯Ÿè€…å®ä¾‹
    // options
    if (options) {
      this.deep = !!options.deep // æ·±åº¦
      this.user = !!options.user
      this.lazy = !!options.lazy
      this.sync = !!options.sync // åŒæ­¥æ‰§è¡Œ
      this.before = options.before
    } else {
      this.deep = this.user = this.lazy = this.sync = false
    }
    this.cb = cb // å›è°ƒ
    this.id = ++uid // uid for batching // å”¯ä¸€æ ‡è¯†
    this.active = true // è§‚å¯Ÿè€…å®ä¾‹æ˜¯å¦æ¿€æ´»
    this.dirty = this.lazy // for lazy watchers
    // é¿å…ä¾èµ–é‡å¤æ”¶é›†çš„å¤„ç†
    this.deps = []
    this.newDeps = []
    this.depIds = new Set()
    this.newDepIds = new Set()
    
    this.expression = process.env.NODE_ENV !== 'production'
      ? expOrFn.toString()
      : ''
    // parse expression for getter
    if (typeof expOrFn === 'function') {
      this.getter = expOrFn
    } else { // ç±»ä¼¼äº Obj.a çš„å­—ç¬¦ä¸²
      this.getter = parsePath(expOrFn)
      if (!this.getter) {
        this.getter = noop // ç©ºå‡½æ•°
        process.env.NODE_ENV !== 'production' && warn(
          `Failed watching path: "${expOrFn}" ` +
          'Watcher only accepts simple dot-delimited paths. ' +
          'For full control, use a function instead.',
          vm
        )
      }
    }
    this.value = this.lazy
      ? undefined
      : this.get()
  }

  get () { // è§¦å‘å–å€¼æ“ä½œï¼Œè¿›è€Œè§¦å‘å±æ€§çš„getter
    pushTarget(this) // Dep ä¸­æåˆ°çš„ï¼šç»™ Dep.target èµ‹å€¼
    let value
    const vm = this.vm
    try {
      // æ ¸å¿ƒï¼Œè¿è¡Œè§‚å¯Ÿè€…è¡¨è¾¾å¼ï¼Œè¿›è¡Œå–å€¼ï¼Œè§¦å‘getterï¼Œä»è€Œåœ¨é—­åŒ…ä¸­æ·»åŠ watcher
      value = this.getter.call(vm, vm)
    } catch (e) {
      if (this.user) {
        handleError(e, vm, `getter for watcher "${this.expression}"`)
      } else {
        throw e
      }
    } finally {
      if (this.deep) { // å¦‚æœè¦æ·±åº¦ç›‘æµ‹ï¼Œå†å¯¹ value æ‰§è¡Œæ“ä½œ
        traverse(value)
      }
      // æ¸…ç†ä¾èµ–æ”¶é›†
      popTarget()
      this.cleanupDeps()
    }
    return value
  }

  addDep (dep: Dep) {
    const id = dep.id
    if (!this.newDepIds.has(id)) { // é¿å…ä¾èµ–é‡å¤æ”¶é›†
      this.newDepIds.add(id)
      this.newDeps.push(dep)
      if (!this.depIds.has(id)) {
        dep.addSub(this) // dep æ·»åŠ è®¢é˜…è€…
      }
    }
  }

  update () { // æ›´æ–°
    /* istanbul ignore else */
    if (this.lazy) {
      this.dirty = true
    } else if (this.sync) {
      this.run() // åŒæ­¥ç›´æ¥è¿è¡Œ
    } else { // å¦åˆ™åŠ å…¥å¼‚æ­¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
      queueWatcher(this)
    }
  }
}
```
åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å¤§æ¦‚æ€»ç»“ä¸€äº›æ•´ä¸ªå“åº”å¼ç³»ç»Ÿçš„æµç¨‹ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´çš„ **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šç¬¬ä¸€æ­¥å½“ç„¶æ˜¯é€šè¿‡ observer è¿›è¡Œæ•°æ®åŠ«æŒï¼Œç„¶ååœ¨éœ€è¦è®¢é˜…çš„åœ°æ–¹ï¼ˆå¦‚ï¼šæ¨¡ç‰ˆç¼–è¯‘ï¼‰ï¼Œæ·»åŠ è§‚å¯Ÿè€…ï¼ˆwatcherï¼‰ï¼Œå¹¶ç«‹åˆ»é€šè¿‡å–å€¼æ“ä½œè§¦å‘æŒ‡å®šå±æ€§çš„ getter æ–¹æ³•ï¼Œä»è€Œå°†è§‚å¯Ÿè€…æ·»åŠ è¿› Dep ï¼ˆåˆ©ç”¨äº†é—­åŒ…çš„ç‰¹æ€§ï¼Œè¿›è¡Œä¾èµ–æ”¶é›†ï¼‰ï¼Œç„¶ååœ¨ Setter è§¦å‘çš„æ—¶å€™ï¼Œè¿›è¡Œ notifyï¼Œé€šçŸ¥ç»™æ‰€æœ‰è§‚å¯Ÿè€…å¹¶è¿›è¡Œç›¸åº”çš„ updateã€‚
## Proxy
> Proxy å¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚â€œæ‹¦æˆªâ€ï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚â€” é˜®ä¸€å³°è€å¸ˆçš„ [ECMAScript 6 å…¥é—¨](http://es6.ruanyifeng.com/#docs/proxy)

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒVue 3.0 è¦ç”¨ `Proxy` æ›¿æ¢ `Object.defineProperty`ï¼Œé‚£ä¹ˆè¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”å¦‚ä¸Šè¿° Vue ç°å­˜çš„ä¸¤ä¸ªé—®é¢˜ï¼Œä¸èƒ½å“åº”å¯¹è±¡å±æ€§çš„æ·»åŠ å’Œåˆ é™¤ä»¥åŠä¸èƒ½ç›´æ¥æ“ä½œæ•°ç»„ä¸‹æ ‡çš„é—®é¢˜ï¼Œéƒ½å¯ä»¥è§£å†³ã€‚ç›ç„¶ä¹Ÿæœ‰ä¸å¥½çš„ï¼Œé‚£å°±æ˜¯å…¼å®¹æ€§é—®é¢˜ï¼Œè€Œä¸”è¿™ä¸ªå…¼å®¹æ€§é—®é¢˜ babel è¿˜æ— æ³•è§£å†³ã€‚
### åŸºç¡€ç”¨æ³•
æˆ‘ä»¬ç”¨ Proxy æ¥ç®€å•å®ç°ä¸€ä¸ªæ•°æ®åŠ«æŒã€‚
``` javascript
let obj = {};
// ä»£ç† obj
let handler = {
    get: function(target, key, receiver) {
        console.log('get', key);
        return Reflect.get(target, key, receiver);
    },
    set: function(target, key, value, receiver) {
        console.log('set', key, value);
        return Reflect.set(target, key, value, receiver);
    },
    deleteProperty(target, key) {
        console.log('delete', key);
        delete target[key];
        return true;
    }
};
let data = new Proxy(obj, handler);
// ä»£ç†ååªèƒ½ä½¿ç”¨ä»£ç†å¯¹è±¡ dataï¼Œå¦åˆ™è¿˜ç”¨ obj è‚¯å®šæ²¡ä½œç”¨
console.log(data.name); // get name ã€undefined
data.name = 'å°¹å¤©ä»‡'; // set name å°¹å¤©ä»‡
delete data.name; // delete name
```
åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œobj æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œé€šè¿‡ Proxy ä»£ç†åï¼Œæ·»åŠ å’Œåˆ é™¤å±æ€§ä¹Ÿèƒ½å¤Ÿå¾—åˆ°åé¦ˆã€‚å†æ¥çœ‹ä¸€ä¸‹æ•°ç»„çš„ä»£ç†ï¼š
``` javascript
let arr = ['å°¹å¤©ä»‡', 'æˆ‘æ˜¯ä¸€ä¸ªæ¼”å‘˜', 'æŸ³é£˜é£˜', 'æ­»è·‘é¾™å¥—çš„'];
let array = new Proxy(arr, handler);
array[1] = 'æˆ‘å…»ä½ å•Š'; // set 1 æˆ‘å…»ä½ å•Š
array[3] = 'å…ˆç®¡å¥½ä½ è‡ªå·±å§ï¼Œå‚»ç“œã€‚'; // set 3 å…ˆç®¡å¥½ä½ è‡ªå·±å§ï¼Œå‚»ç“œã€‚
```
æ•°ç»„ç´¢å¼•çš„è®¾ç½®ä¹Ÿæ˜¯å®Œå…¨ hold å¾—ä½å•Šï¼Œå½“ç„¶ Proxy çš„ç”¨å¤„ä¹Ÿä¸ä»…ä»…æ˜¯è¿™äº›ï¼Œæ”¯æŒæ‹¦æˆªçš„æ“ä½œå°±æœ‰ 13 ç§ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹ [é˜®ä¸€å³°è€å¸ˆçš„ä¹¦](http://es6.ruanyifeng.com/#docs/proxy)ï¼Œè¿™é‡Œå°±ä¸å†å•°å—¦ã€‚
### Proxy å®ç°è§‚å¯Ÿè€…æ¨¡å¼
æˆ‘ä»¬å‰é¢åˆ†æäº† Vue çš„æºç ï¼Œä¹Ÿäº†è§£äº†è§‚å¯Ÿè€…æ¨¡å¼çš„åŸºæœ¬åŸç†ã€‚é‚£ç”¨ Proxy å¦‚ä½•å®ç°è§‚å¯Ÿè€…å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç®€å•å†™ä¸€ä¸‹ï¼š
``` javascript
class Dep {
    constructor() {
        this.subs = new Set(); 
        // Set ç±»å‹ï¼Œä¿è¯ä¸ä¼šé‡å¤
    }
    addSub(sub) { // æ·»åŠ è®¢é˜…è€…
        this.subs.add(sub);
    }
    notify(key) { // é€šçŸ¥è®¢é˜…è€…æ›´æ–°
        this.subs.forEach(sub => {
            sub.update();
        });
    }
}
class Watcher { // è§‚å¯Ÿè€…
    constructor(obj, key, cb) {
        this.obj = obj;
        this.key = key;
        this.cb = cb; // å›è°ƒ
        this.value = this.get(); // è·å–è€æ•°æ®
    }
    get() { // å–å€¼è§¦å‘é—­åŒ…ï¼Œå°†è‡ªèº«æ·»åŠ åˆ°depä¸­
        Dep.target = this; // è®¾ç½® Dep.target ä¸ºè‡ªèº«
        let value = this.obj[this.key];
        Dep.target = null; // å–å€¼å®Œå è®¾ç½®ä¸ºnul
        return value;
    }
    // æ›´æ–°
    update() {
        let newVal = this.obj[this.key];
        if (this.value !== newVal) {
            this.cb(newVal);
            this.value = newVal;
        }
    }
}
function Observer(obj) {
    Object.keys(obj).forEach(key => { // åšæ·±åº¦ç›‘å¬
        if (typeof obj[key] === 'object') {
            obj[key] = Observer(obj[key]);
        }
    });
    let dep = new Dep();
    let handler = {
        get: function (target, key, receiver) {
            Dep.target && dep.addSub(Dep.target);
            // å­˜åœ¨ Dep.targetï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°depå®ä¾‹ä¸­
            return Reflect.get(target, key, receiver);
        },
        set: function (target, key, value, receiver) {
            let result = Reflect.set(target, key, value, receiver);
            dep.notify(); // è¿›è¡Œå‘å¸ƒ
            return result;
        }
    };
    return new Proxy(obj, handler)
}
```
ä»£ç æ¯”è¾ƒç®€çŸ­ï¼Œå°±æ”¾åœ¨ä¸€å—äº†ã€‚æ•´ä½“æ€è·¯å’Œ Vue çš„å·®ä¸å¤šï¼Œéœ€è¦æ³¨æ„çš„ç‚¹åœ¨äºï¼šã€‚

å†çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š
``` javascript
let data = {
    name: 'æ¸£æ¸£è¾‰'
};
function print1(data) {
    console.log('æˆ‘ç³»', data);
}
function print2(data) {
    console.log('æˆ‘ä»Šå¹´', data);
}
data = Observer(data);
new Watcher(data, 'name', print1);
data.name = 'æ¨è¿‡'; // æˆ‘ç³» æ¨è¿‡

new Watcher(data, 'age', print2);
data.age = '24'; // æˆ‘ä»Šå¹´ 24
```
## MVVM
### æ¦‚å¿µ