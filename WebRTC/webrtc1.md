## å‰è¨€
  ã€ **ä»å¤´åˆ°è„š** ã€‘ä¼šä½œä¸ºä¸€ä¸ªç³»åˆ—æ–‡ç« æ¥å‘å¸ƒï¼Œå®ƒåŒ…æ‹¬ä½†ä¸é™äº WebRTC å¤šäººè§†é¢‘ï¼Œé¢„è®¡ä¼šæœ‰ï¼š
   * WebRTC å®æˆ˜ï¼ˆä¸€ï¼‰ï¼šä¹Ÿå°±æ˜¯æœ¬æœŸï¼Œä¸»è¦æ˜¯åŸºç¡€è®²è§£ä»¥åŠä¸€å¯¹ä¸€çš„æœ¬åœ°å¯¹ç­‰è¿æ¥ï¼Œç½‘ç»œå¯¹ç­‰è¿æ¥ã€‚
   * WebRTC å®æˆ˜ï¼ˆäºŒï¼‰ï¼šä¸»è¦è®²è§£æ•°æ®ä¼ è¾“ä»¥åŠå¤šç«¯æœ¬åœ°å¯¹ç­‰è¿æ¥ã€ç½‘ç»œå¯¹ç­‰è¿æ¥ã€‚
   * WebRTC å®æˆ˜ï¼ˆä¸‰ï¼‰ï¼šå®ç°ä¸€ä¸ªä¸€å¯¹ä¸€çš„è§†é¢‘èŠå¤©é¡¹ç›®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæˆªå›¾ã€å½•åˆ¶ç­‰ã€‚
   * WebRTC + Canvas å®ç°ä¸€ä¸ªå…±äº«ç”»æ¿é¡¹ç›®ã€‚
   * ä½œè€…å¼€æºä½œå“  [ğŸ’˜ğŸ¦ğŸ™ˆVchat â€” ä¸€ä¸ªç¤¾äº¤èŠå¤©ç³»ç»Ÿï¼ˆvue + node + mongodbï¼‰](https://github.com/wuyawei/Vchat) çš„ç³»åˆ—æ–‡ç« 
  
  å› ä¸ºæ–‡ç« è¾“å‡ºç¡®å®è¦è€—è´¹å¾ˆå¤§çš„ç²¾åŠ›ï¼Œæ‰€ä»¥ä¸Šé¢è®¡åˆ’ä¸ä¸€å®šæ˜¯è¿™ä¸ªå‘å¸ƒé¡ºåºï¼Œä¸­é—´ä¹Ÿä¼šç©¿æ’å‘å¸ƒå…¶å®ƒæ–¹å‘çš„æ–‡ç« ï¼Œå¦‚ Vueã€JavaScript æˆ–è€…å…¶ä»–å­¦ä¹ çš„ä¸»é¢˜ã€‚åœ¨æ–‡ç« é‡Œï¼Œä¼šæŠŠæˆ‘è‡ªå·±é‡åˆ°è¿‡çš„ä¸€äº›å‘ç‚¹é‡ç‚¹æç¤ºå¤§å®¶æ³¨æ„ï¼Œå°½é‡è®©å¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­å°‘èµ°å¼¯è·¯ã€‚å½“ç„¶ï¼Œæˆ‘çš„ä¹Ÿå¹¶ä¸æ˜¯æ ‡å‡†ç­”æ¡ˆï¼Œåªæ˜¯æˆ‘ä¸ªäººçš„æ€è·¯ã€‚å¦‚æœå¤§å®¶æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œå¯ä»¥äº’ç›¸äº¤æµï¼Œä¹Ÿå¸Œæœ›å¤§å®¶éƒ½èƒ½æœ‰æ‰€æ”¶è·ã€‚
  
  åœ¨è¿™é‡Œä¹Ÿå¸Œæœ›å¤§å®¶å¯ä»¥ **å…³æ³¨** ä¸€æ³¢ï¼Œä½ ä»¬çš„å…³æ³¨æ”¯æŒï¼Œä¹Ÿèƒ½æ¿€åŠ±æˆ‘è¾“å‡ºæ›´å¥½çš„æ–‡ç« ã€‚
  * æœ¬æ–‡ç¤ºä¾‹ **æºç åº“** [webrtc-stream](https://github.com/wuyawei/webrtc-stream)
  * **æ–‡ç« ä»“åº“** [ğŸ¹ğŸ°fe-code](https://github.com/wuyawei/fe-code)
  * æœ¬æ–‡[æ¼”ç¤ºåœ°å€](https://webrtc-stream-jukbknonbo.now.sh/#/)ï¼ˆå»ºè®®è°·æ­ŒæŸ¥çœ‹ï¼‰
  
  å…ˆæ”¾ä¸ªæ•ˆæœå›¾ï¼Œè¿™æœŸçš„ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ª 1 V 1 çš„è§†é¢‘é€šè¯ï¼ˆç¬”è®°æœ¬æ‘„åƒå¤´ä¸èƒ½ç”¨äº†ï¼Œç”¨çš„è™šæ‹Ÿæ‘„åƒå¤´ï¼‰ã€‚æ–‡ç« æ¯”è¾ƒé•¿ï¼Œå¯ä»¥ mark ä»¥åæ…¢æ…¢çœ‹ã€‚
  
![](https://user-gold-cdn.xitu.io/2019/3/18/1698e9ec991d201b?w=600&h=203&f=webp&s=6308)
  
  æ–‡ç« æœ«å°¾æœ‰ **äº¤æµç¾¤** å’Œ **å…¬ä¼—å·**ï¼Œå¸Œæœ›å¤§å®¶æ”¯æŒï¼Œæ„Ÿè°¢ğŸ»ã€‚
## ä»€ä¹ˆæ˜¯ WebRTC ï¼Ÿ
  WebRTC æ˜¯ç”±ä¸€å®¶åä¸º Gobal IP Solutionsï¼Œç®€ç§° GIPS çš„ç‘å…¸å…¬å¸å¼€å‘çš„ã€‚Google åœ¨ 2011 å¹´æ”¶è´­äº† GIPSï¼Œå¹¶å°†å…¶æºä»£ç å¼€æºã€‚ç„¶ååˆä¸ IETF å’Œ W3C çš„ç›¸å…³æ ‡å‡†æœºæ„åˆä½œï¼Œä»¥ç¡®ä¿è¡Œä¸šè¾¾æˆå…±è¯†ã€‚å…¶ä¸­ï¼š
  
  * Web Real-Time Communications (WEBRTC) W3C ç»„ç»‡ï¼šå®šä¹‰æµè§ˆå™¨ APIã€‚
  * Real-Time Communication in Web-browsers (RTCWEB) IETF æ ‡å‡†ç»„ç»‡ï¼šå®šä¹‰å…¶æ‰€éœ€çš„åè®®ï¼Œæ•°æ®ï¼Œå®‰å…¨æ€§ç­‰æ‰‹æ®µã€‚
  
  ç®€å•æ¥è¯´ï¼ŒWebRTC æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ Web åº”ç”¨ç¨‹åºä¸­å®ç°éŸ³é¢‘ï¼Œè§†é¢‘å’Œæ•°æ®çš„å®æ—¶é€šä¿¡çš„å¼€æºé¡¹ç›®ã€‚åœ¨å®æ—¶é€šä¿¡ä¸­ï¼ŒéŸ³è§†é¢‘çš„é‡‡é›†å’Œå¤„ç†æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ã€‚æ¯”å¦‚éŸ³è§†é¢‘æµçš„ç¼–è§£ç ã€é™å™ªå’Œå›å£°æ¶ˆé™¤ç­‰ï¼Œä½†æ˜¯åœ¨ WebRTC ä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½äº¤ç”±æµè§ˆå™¨çš„åº•å±‚å°è£…æ¥å®Œæˆã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿åˆ°ä¼˜åŒ–åçš„åª’ä½“æµï¼Œç„¶åå°†å…¶è¾“å‡ºåˆ°æœ¬åœ°å±å¹•å’Œæ‰¬å£°å™¨ï¼Œæˆ–è€…è½¬å‘ç»™å…¶å¯¹ç­‰ç«¯ã€‚
  
  WebRTC çš„éŸ³è§†é¢‘å¤„ç†å¼•æ“ï¼š
  
![WebRTC çš„éŸ³è§†é¢‘å¤„ç†å¼•æ“](https://user-gold-cdn.xitu.io/2019/3/13/16976878d1a2966c?w=616&h=456&f=png&s=12950)
  
  æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸éœ€è¦ä»»ä½•ç¬¬ä¸‰æ–¹æ’ä»¶çš„æƒ…å†µä¸‹ï¼Œå®ç°ä¸€ä¸ªæµè§ˆå™¨åˆ°æµè§ˆå™¨çš„ç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰è¿æ¥ï¼Œä»è€Œè¿›è¡ŒéŸ³è§†é¢‘å®æ—¶é€šä¿¡ã€‚å½“ç„¶ï¼ŒWebRTC æä¾›äº†ä¸€äº› API ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œåœ¨å®æ—¶éŸ³è§†é¢‘é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ç”¨åˆ°ä»¥ä¸‹ä¸‰ä¸ªï¼š
  
   * getUserMediaï¼šè·å–éŸ³é¢‘å’Œè§†é¢‘æµï¼ˆMediaStreamï¼‰
   * RTCPeerConnectionï¼šç‚¹å¯¹ç‚¹é€šä¿¡
   * RTCDataChannelï¼šæ•°æ®é€šä¿¡
   
  ä¸è¿‡ï¼Œè™½ç„¶æµè§ˆå™¨ç»™æˆ‘ä»¬è§£å†³äº†å¤§éƒ¨åˆ†éŸ³è§†é¢‘å¤„ç†é—®é¢˜ï¼Œä½†æ˜¯ä»æµè§ˆå™¨è¯·æ±‚éŸ³é¢‘å’Œè§†é¢‘æ—¶ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦ç‰¹åˆ«æ³¨æ„æµçš„å¤§å°å’Œè´¨é‡ã€‚å› ä¸ºå³ä¾¿ç¡¬ä»¶èƒ½å¤Ÿæ•è·é«˜æ¸…è´¨é‡æµï¼ŒCPU å’Œå¸¦å®½ä¹Ÿä¸ä¸€å®šå¯ä»¥è·Ÿä¸Šï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å»ºç«‹å¤šä¸ªå¯¹ç­‰è¿æ¥æ—¶ï¼Œä¸å¾—ä¸è€ƒè™‘çš„é—®é¢˜ã€‚
  
## å®ç°
  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡åˆ†æä¸Šæ–‡æåˆ°çš„ APIï¼Œæ¥é€æ­¥å¼„æ‡‚ WebRTC å®æ—¶é€šä¿¡å®ç°çš„æµç¨‹ã€‚
### getUserMedia
#### MediaStream

 getUserMedia è¿™ä¸ª API å¤§å®¶å¯èƒ½å¹¶ä¸é™Œç”Ÿï¼Œå› ä¸ºå¸¸è§çš„ H5 å½•éŸ³ç­‰åŠŸèƒ½å°±éœ€è¦ç”¨åˆ°å®ƒï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥è·å–è®¾å¤‡çš„åª’ä½“æµï¼ˆå³ MediaStreamï¼‰ã€‚å®ƒå¯ä»¥æ¥å—ä¸€ä¸ªçº¦æŸå¯¹è±¡ constraints ä½œä¸ºå‚æ•°ï¼Œç”¨æ¥æŒ‡å®šéœ€è¦è·å–åˆ°ä»€ä¹ˆæ ·çš„åª’ä½“æµã€‚
``` javascript
    navigator.mediaDevices.getUserMedia({ audio: true, video: true }) 
    // å‚æ•°è¡¨ç¤ºéœ€è¦åŒæ—¶è·å–åˆ°éŸ³é¢‘å’Œè§†é¢‘
        .then(stream => {
          // è·å–åˆ°ä¼˜åŒ–åçš„åª’ä½“æµ
          let video = document.querySelector('#rtc');
          video.srcObject = stream;
        })
        .catch(err => {
          // æ•è·é”™è¯¯
        });
```
  æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹è·å–åˆ°çš„ MediaStreamã€‚
  
![](https://user-gold-cdn.xitu.io/2019/3/14/1697afbf32a4ec6f?w=320&h=457&f=png&s=73734)

  å¯ä»¥çœ‹åˆ°å®ƒæœ‰å¾ˆå¤šå±æ€§ï¼Œæˆ‘ä»¬åªéœ€è¦äº†è§£ä¸€ä¸‹å°±å¥½ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaStream)ã€‚
  
    * id [String]: å¯¹å½“å‰çš„ MS è¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚æ‰€ä»¥æ¯æ¬¡åˆ·æ–°æµè§ˆå™¨æˆ–æ˜¯é‡æ–°è·å– MSï¼Œid éƒ½ä¼šå˜åŠ¨ã€‚
    * active [boolean]: è¡¨ç¤ºå½“å‰ MS æ˜¯å¦æ˜¯æ´»è·ƒçŠ¶æ€ï¼ˆå°±æ˜¯æ˜¯å¦å¯ä»¥æ’­æ”¾ï¼‰ã€‚
    * onactive: å½“ active ä¸º true æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶ã€‚
  
  ç»“åˆä¸Šå›¾ï¼Œæˆ‘ä»¬é¡ºä¾¿å¤ä¹ ä¸€ä¸‹ä¸ŠæœŸè®²çš„åŸå‹å’ŒåŸå‹é“¾ã€‚MediaStream çš„ `__proto__` æŒ‡å‘å®ƒçš„æ„é€ å‡½æ•°æ‰€å¯¹åº”çš„åŸå‹å¯¹è±¡ï¼Œåœ¨åŸå‹å¯¹è±¡ä¸­åˆæœ‰ä¸€ä¸ª constructor å±æ€§æŒ‡å‘äº†å®ƒæ‰€å¯¹åº”çš„æ„é€ å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ MediaStream çš„æ„é€ å‡½æ•°æ˜¯ä¸€ä¸ªåä¸º MediaStream çš„å‡½æ•°ã€‚å¯èƒ½è¯´å¾—æœ‰ä¸€ç‚¹ç»•ï¼Œå¯¹åŸå‹è¿˜ä¸ç†Ÿæ‚‰çš„åŒå­¦ï¼Œå¯ä»¥å»çœ‹ä¸€ä¸‹ä¸ŠæœŸæ–‡ç«  [JavaScript åŸå‹å’ŒåŸå‹é“¾åŠ canvas éªŒè¯ç å®è·µ](https://juejin.im/post/5c7b524ee51d453ee81877a7)ã€‚
  
  è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡ getAudioTracks()ã€getVideoTracks() æ¥æŸ¥çœ‹è·å–åˆ°çš„æµçš„æŸäº›ä¿¡æ¯ï¼Œæ›´å¤šä¿¡æ¯æŸ¥çœ‹ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaStreamTrack)ã€‚

  ![](https://user-gold-cdn.xitu.io/2019/3/14/1697b85bb19a0658?w=600&h=196&f=png&s=47157)
  
    * kind: æ˜¯å½“å‰è·å–çš„åª’ä½“æµç±»å‹ï¼ˆAudio/Videoï¼‰ã€‚
    * label: æ˜¯åª’ä½“è®¾å¤‡ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯è™šæ‹Ÿæ‘„åƒå¤´ã€‚
    * muted: è¡¨ç¤ºåª’ä½“è½¨é“æ˜¯å¦é™éŸ³ã€‚
#### å…¼å®¹æ€§

  ç»§ç»­æ¥çœ‹ getUserMediaï¼Œ`navigator.mediaDevices.getUserMedia` æ˜¯æ–°ç‰ˆçš„ APIï¼Œæ—§ç‰ˆçš„æ˜¯ `navigator.getUserMedia`ã€‚ä¸ºäº†é¿å…å…¼å®¹æ€§é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼ˆå…¶å®è¯´åˆ°åº•ï¼Œç°åœ¨ WebRTC çš„æ”¯æŒç‡è¿˜ä¸ç®—é«˜ï¼Œæœ‰éœ€è¦çš„å¯ä»¥é€‰æ‹©ä¸€äº›é€‚é…å™¨ï¼Œå¦‚ `adapter.js`ï¼‰ã€‚
``` javascript
    // åˆ¤æ–­æ˜¯å¦æœ‰ navigator.mediaDevicesï¼Œæ²¡æœ‰èµ‹æˆç©ºå¯¹è±¡
    if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
    }
    
    // ç»§ç»­åˆ¤æ–­æ˜¯å¦æœ‰ navigator.mediaDevices.getUserMediaï¼Œæ²¡æœ‰å°±é‡‡ç”¨ navigator.getUserMedia
    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia = function(prams) {
            let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            // å…¼å®¹è·å–
            if (!getUserMedia) {
                return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
            }
            return new Promise(function(resolve, reject) {
                getUserMedia.call(navigator, prams, resolve, reject);
            });
        };
    }
    navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
            let video = document.querySelector('#Rtc');
            if ('srcObject' in video) { // åˆ¤æ–­æ˜¯å¦æ”¯æŒ srcObject å±æ€§
                video.srcObject = stream;
            } else {
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function(e) {
                video.play();
            };
        })
        .catch((err) => { // æ•è·é”™è¯¯
            console.error(err.name + ': ' + err.message);
        });
```
#### constraints

 å¯¹äº constraints çº¦æŸå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ¥æŒ‡å®šä¸€äº›å’Œåª’ä½“æµæœ‰å…³çš„å±æ€§ã€‚æ¯”å¦‚æŒ‡å®šæ˜¯å¦è·å–æŸç§æµï¼š
``` javascript
    navigator.mediaDevices.getUserMedia({ audio: false, video: true });
    // åªéœ€è¦è§†é¢‘æµï¼Œä¸è¦éŸ³é¢‘
```
æŒ‡å®šè§†é¢‘æµçš„å®½é«˜ã€å¸§ç‡ä»¥åŠç†æƒ³å€¼ï¼š
``` javascript
    // è·å–æŒ‡å®šå®½é«˜ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼šåœ¨æ”¹å˜è§†é¢‘æµçš„å®½é«˜æ—¶ï¼Œ
    // å¦‚æœå®½é«˜æ¯”å’Œé‡‡é›†åˆ°çš„ä¸ä¸€æ ·ï¼Œä¼šç›´æ¥æˆªæ‰æŸéƒ¨åˆ†
    { audio: false, 
      video: { width: 1280, height: 720 } 
    }
    // è®¾å®šç†æƒ³å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼
    {
      audio: true,
      video: {
        width: { min: 1024, ideal: 1280, max: 1920 },
        height: { min: 776, ideal: 720, max: 1080 }
      }
    }
```
  å¯¹äºç§»åŠ¨è®¾å¤‡æ¥è¯´ï¼Œè¿˜å¯ä»¥æŒ‡å®šè·å–å‰æ‘„åƒå¤´ï¼Œæˆ–è€…åç½®æ‘„åƒå¤´ï¼š
``` javascript
    { audio: true, video: { facingMode: "user" } } // å‰ç½®
    { audio: true, video: { facingMode: { exact: "environment" } } } // åç½®
    // ä¹Ÿå¯ä»¥æŒ‡å®šè®¾å¤‡ idï¼Œ
    // é€šè¿‡ navigator.mediaDevices.enumerateDevices() å¯ä»¥è·å–åˆ°æ”¯æŒçš„è®¾å¤‡
    { video: { deviceId: myCameraDeviceId } }
```
  è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å°±æ˜¯è®¾ç½®è§†é¢‘æºä¸ºå±å¹•ï¼Œä½†æ˜¯ç›®å‰åªæœ‰ç«ç‹æ”¯æŒäº†è¿™ä¸ªå±æ€§ã€‚
``` javascript
    { audio: true, video: {mediaSource: 'screen'} } 
```
  è¿™é‡Œå°±ä¸æ¥ç€åšæ¬è¿å·¥äº†ï¼Œæ›´å¤šç²¾å½©å°½åœ¨ [MDN](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)ï¼Œ^_^!
### RTCPeerConnection
> RTCPeerConnection æ¥å£ä»£è¡¨ä¸€ä¸ªç”±æœ¬åœ°è®¡ç®—æœºåˆ°è¿œç«¯çš„ WebRTC è¿æ¥ã€‚è¯¥æ¥å£æä¾›äº†åˆ›å»ºï¼Œä¿æŒï¼Œç›‘æ§ï¼Œå…³é—­è¿æ¥çš„æ–¹æ³•çš„å®ç°ã€‚â€”â€” MDN
  
#### æ¦‚è¿°
  
    RTCPeerConnection ä½œä¸ºåˆ›å»ºç‚¹å¯¹ç‚¹è¿æ¥çš„ APIï¼Œæ˜¯æˆ‘ä»¬å®ç°éŸ³è§†é¢‘å®æ—¶é€šä¿¡çš„å…³é”®ã€‚åœ¨ç‚¹å¯¹ç‚¹é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦äº¤æ¢ä¸€ç³»åˆ—ä¿¡æ¯ï¼Œé€šå¸¸è¿™ä¸€è¿‡ç¨‹å«åš â€” ä¿¡ä»¤ï¼ˆsignalingï¼‰ã€‚åœ¨ä¿¡ä»¤é˜¶æ®µéœ€è¦å®Œæˆçš„ä»»åŠ¡ï¼š
  
     * ä¸ºæ¯ä¸ªè¿æ¥ç«¯åˆ›å»ºä¸€ä¸ª RTCPeerConnectionï¼Œå¹¶æ·»åŠ æœ¬åœ°åª’ä½“æµã€‚
     * è·å–å¹¶äº¤æ¢æœ¬åœ°å’Œè¿œç¨‹æè¿°ï¼šSDP æ ¼å¼çš„æœ¬åœ°åª’ä½“å…ƒæ•°æ®ã€‚
     * è·å–å¹¶äº¤æ¢ç½‘ç»œä¿¡æ¯ï¼šæ½œåœ¨çš„è¿æ¥ç«¯ç‚¹ç§°ä¸º ICE å€™é€‰è€…ã€‚
  
  æˆ‘ä»¬è™½ç„¶æŠŠ WebRTC ç§°ä¹‹ä¸ºç‚¹å¯¹ç‚¹çš„è¿æ¥ï¼Œä½†å¹¶ä¸ä»£è¡¨åœ¨å®ç°è¿‡ç¨‹ä¸­ä¸éœ€è¦æœåŠ¡å™¨çš„å‚ä¸ã€‚ç›¸åï¼Œåœ¨ç‚¹å¯¹ç‚¹çš„ä¿¡é“å»ºç«‹èµ·æ¥ä¹‹å‰ï¼ŒäºŒè€…ä¹‹é—´æ˜¯æ²¡æœ‰åŠæ³•é€šä¿¡çš„ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œåœ¨ä¿¡ä»¤é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€šä¿¡æœåŠ¡æ¥å¸®åŠ©æˆ‘ä»¬å»ºç«‹èµ·è¿™ä¸ªè¿æ¥ã€‚WebRTC æœ¬èº«æ²¡æœ‰æŒ‡å®šæŸä¸€ä¸ªä¿¡ä»¤æœåŠ¡ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½†ä¸é™äºä½¿ç”¨ XMPPã€XHRã€Socket ç­‰æ¥åšä¿¡ä»¤äº¤æ¢æ‰€éœ€çš„æœåŠ¡ã€‚æˆ‘åœ¨å·¥ä½œä¸­é‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯åŸºäº XMPP åè®®çš„`Strophe.js`æ¥åšåŒå‘é€šä¿¡ï¼Œä½†æ˜¯åœ¨æœ¬ä¾‹ä¸­åˆ™ä¼šä½¿ç”¨`Socket.io `ä»¥åŠ Koa æ¥åšé¡¹ç›®æ¼”ç¤ºã€‚
#### NAT ç©¿è¶ŠæŠ€æœ¯

  æˆ‘ä»¬å…ˆçœ‹è¿æ¥ä»»åŠ¡çš„ç¬¬ä¸€æ¡ï¼šä¸ºæ¯ä¸ªè¿æ¥ç«¯åˆ›å»ºä¸€ä¸ª RTCPeerConnectionï¼Œå¹¶æ·»åŠ æœ¬åœ°åª’ä½“æµã€‚äº‹å®ä¸Šï¼Œå¦‚æœæ˜¯ä¸€èˆ¬ç›´æ’­æ¨¡å¼ï¼Œåˆ™åªéœ€è¦æ’­æ”¾ç«¯æ·»åŠ æœ¬åœ°æµè¿›è¡Œè¾“å‡ºï¼Œå…¶ä»–å‚ä¸è€…åªéœ€è¦æ¥å—æµè¿›è¡Œè§‚çœ‹å³å¯ã€‚
  
  å› ä¸ºå„æµè§ˆå™¨å·®å¼‚ï¼ŒRTCPeerConnection ä¸€æ ·éœ€è¦åŠ ä¸Šå‰ç¼€ã€‚
``` javascript
let PeerConnection = window.RTCPeerConnection ||
                     window.mozRTCPeerConnection ||
                     window.webkitRTCPeerConnection;
let peer = new PeerConnection(iceServers);
```
  æˆ‘ä»¬çœ‹è§ RTCPeerConnection ä¹ŸåŒæ ·æ¥æ”¶ä¸€ä¸ªå‚æ•° â€” iceServersï¼Œå…ˆæ¥çœ‹çœ‹å®ƒé•¿ä»€ä¹ˆæ ·ï¼š
``` javascript
{
  iceServers: [
    { url: "stun:stun.l.google.com:19302"}, // è°·æ­Œçš„å…¬å…±æœåŠ¡
    {
      url: "turn:***",
      username: ***, // ç”¨æˆ·å
      credential: *** // å¯†ç 
    }
  ]
}
```
  å‚æ•°é…ç½®äº†ä¸¤ä¸ª urlï¼Œåˆ†åˆ«æ˜¯ STUN å’Œ TURNï¼Œè¿™ä¾¿æ˜¯ WebRTC å®ç°ç‚¹å¯¹ç‚¹é€šä¿¡çš„å…³é”®ï¼Œä¹Ÿæ˜¯ä¸€èˆ¬ P2P è¿æ¥éƒ½éœ€è¦è§£å†³çš„é—®é¢˜ï¼šNATç©¿è¶Šã€‚
  
  NATï¼ˆNetwork Address Translationï¼Œç½‘ç»œåœ°å€è½¬æ¢ï¼‰ç®€å•æ¥è¯´å°±æ˜¯ä¸ºäº†è§£å†³ IPV4 ä¸‹çš„ IP åœ°å€åŒ®ä¹è€Œå‡ºç°çš„ä¸€ç§æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª å…¬ç½‘ IP åœ°å€ä¸€èˆ¬éƒ½å¯¹åº” n ä¸ªå†…ç½‘ IPã€‚è¿™æ ·ä¹Ÿå°±ä¼šå¯¼è‡´ä¸æ˜¯åŒä¸€å±€åŸŸç½‘ä¸‹çš„æµè§ˆå™¨åœ¨å°è¯• WebRTC è¿æ¥æ—¶ï¼Œæ— æ³•ç›´æ¥æ‹¿åˆ°å¯¹æ–¹çš„å…¬ç½‘ IP ä¹Ÿå°±ä¸èƒ½è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥å°±éœ€è¦ç”¨åˆ° NAT ç©¿è¶Šï¼ˆä¹Ÿå«æ‰“æ´ï¼‰ã€‚ä»¥ä¸‹ä¸º NAT ç©¿è¶ŠåŸºæœ¬æµç¨‹ï¼š
  
  ![](https://user-gold-cdn.xitu.io/2019/3/16/16984621b1f7f498?w=676&h=434&f=png&s=88128)
  
  ä¸€èˆ¬æƒ…å†µä¸‹ä¼šé‡‡ç”¨ ICE åè®®æ¡†æ¶è¿›è¡Œ NAT ç©¿è¶Šï¼ŒICE çš„å…¨ç§°ä¸º Interactive Connectivity Establishmentï¼Œå³äº¤äº’å¼è¿æ¥å»ºç«‹ã€‚å®ƒä½¿ç”¨ STUN åè®®ä»¥åŠ TURN åè®®æ¥è¿›è¡Œç©¿è¶Šã€‚å…³äº NAT ç©¿è¶Šçš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒ  [ICEåè®®ä¸‹NATç©¿è¶Šçš„å®ç°ï¼ˆSTUN&TURNï¼‰](https://www.jianshu.com/p/84e8c78ca61d)ã€[P2Pé€šä¿¡æ ‡å‡†åè®®(ä¸‰)ä¹‹ICE](https://www.cnblogs.com/pannengzhi/p/5061674.html)ã€‚
  
  åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒWebRTC çš„é€šä¿¡è‡³å°‘éœ€è¦ä¸¤ç§æœåŠ¡é…åˆï¼š
  * ä¿¡ä»¤é˜¶æ®µéœ€è¦åŒå‘é€šä¿¡æœåŠ¡è¾…åŠ©ä¿¡æ¯äº¤æ¢ã€‚
  * STUNã€TURNè¾…åŠ©å®ç° NAT ç©¿è¶Šã€‚
#### å»ºç«‹ç‚¹å¯¹ç‚¹è¿æ¥

  WebRTC çš„ç‚¹å¯¹ç‚¹è¿æ¥åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„è¿‡ç¨‹å‘¢ï¼Œæˆ‘ä»¬é€šè¿‡ç»“åˆå›¾ä¾‹æ¥åˆ†æè¿æ¥ã€‚

  ![](https://user-gold-cdn.xitu.io/2019/3/15/169810c20bb10132?w=680&h=189&f=png&s=6589)

  æ˜¾è€Œæ˜“è§ï¼Œåœ¨ä¸Šè¿°è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼š 
  
  **å‘¼å«ç«¯**ï¼ˆåœ¨è¿™é‡Œéƒ½æ˜¯æŒ‡ä»£æµè§ˆå™¨ï¼‰éœ€è¦ç»™ **æ¥æ”¶ç«¯** å‘é€ä¸€æ¡åä¸º offer çš„ä¿¡æ¯ã€‚
  
  **æ¥æ”¶ç«¯** åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œåˆ™è¿”å›ä¸€æ¡ answer ä¿¡æ¯ç»™ **å‘¼å«ç«¯**ã€‚
     
  è¿™ä¾¿æ˜¯ä¸Šè¿°ä»»åŠ¡ä¹‹ä¸€ ï¼ŒSDP æ ¼å¼çš„æœ¬åœ°åª’ä½“å…ƒæ•°æ®çš„äº¤æ¢ã€‚sdp ä¿¡æ¯ä¸€èˆ¬é•¿è¿™æ ·ï¼š
``` javascript
    v=0
    o=- 1837933589686018726 2 IN IP4 127.0.0.1
    s=-
    t=0 0
    a=group:BUNDLE audio video
    a=msid-semantic: WMS yvKeJMUSZzvJlAJHn4unfj6q9DMqmb6CrCOT
    m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 106 105 13 110 112 113 126
    ...
    ...
```
  
  ä½†æ˜¯ä»»åŠ¡ä¸ä»…ä»…æ˜¯äº¤æ¢ï¼Œè¿˜éœ€è¦åˆ†åˆ«ä¿å­˜è‡ªå·±å’Œå¯¹æ–¹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å†åŠ ç‚¹æ–™ï¼š
  
  ![](https://user-gold-cdn.xitu.io/2019/3/15/169810cd0eb2e77c?w=680&h=280&f=png&s=12173)
  
     * **å‘¼å«ç«¯** åˆ›å»º offer ä¿¡æ¯åï¼Œå…ˆè°ƒç”¨ setLocalDescription å­˜å‚¨æœ¬åœ° offer æè¿°ï¼Œå†å°†å…¶å‘é€ç»™ **æ¥æ”¶ç«¯**ã€‚
     * **æ¥æ”¶ç«¯** æ”¶åˆ° offer åï¼Œå…ˆè°ƒç”¨ setRemoteDescription å­˜å‚¨è¿œç«¯ offer æè¿°ï¼›ç„¶ååˆåˆ›å»º answer ä¿¡æ¯ï¼ŒåŒæ ·éœ€è¦è°ƒç”¨ setLocalDescription å­˜å‚¨æœ¬åœ° answer æè¿°ï¼Œå†è¿”å›ç»™ **æ¥æ”¶ç«¯**
     * **å‘¼å«ç«¯** æ‹¿åˆ° answer åï¼Œå†æ¬¡è°ƒç”¨ setRemoteDescription è®¾ç½®è¿œç«¯ answer æè¿°ã€‚
     
  åˆ°è¿™é‡Œç‚¹å¯¹ç‚¹è¿æ¥è¿˜ç¼ºä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œä¿¡æ¯ ICE å€™é€‰äº¤æ¢ã€‚ä¸è¿‡è¿™ä¸€æ­¥å’Œ offerã€answer ä¿¡æ¯çš„äº¤æ¢å¹¶æ²¡æœ‰å…ˆåé¡ºåºï¼Œæµç¨‹ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å³ï¼šåœ¨**å‘¼å«ç«¯**å’Œ**æ¥æ”¶ç«¯**çš„ ICE å€™é€‰ä¿¡æ¯å‡†å¤‡å®Œæˆåï¼Œè¿›è¡Œäº¤æ¢ï¼Œå¹¶äº’ç›¸ä¿å­˜å¯¹æ–¹çš„ä¿¡æ¯ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡è¿æ¥ã€‚
  
  ![](https://user-gold-cdn.xitu.io/2019/3/16/169860e7cf668614?w=904&h=785&f=png&s=75228)

  è¿™å¼ å›¾æ˜¯æˆ‘è®¤ä¸ºæ¯”è¾ƒå®Œå–„çš„äº†ï¼Œè¯¦ç»†çš„æè¿°äº†æ•´ä¸ªè¿æ¥çš„è¿‡ç¨‹ã€‚æ­£å¥½æˆ‘ä»¬å†æ¥å°ç»“ä¸€ä¸‹ï¼š
  
     * åŸºç¡€è®¾æ–½ï¼šå¿…è¦çš„ä¿¡ä»¤æœåŠ¡å’Œ NAT ç©¿è¶ŠæœåŠ¡
     * clientA å’Œ clientB åˆ†åˆ«åˆ›å»º RTCPeerConnection å¹¶ä¸ºè¾“å‡ºç«¯æ·»åŠ æœ¬åœ°åª’ä½“æµã€‚å¦‚æœæ˜¯è§†é¢‘é€šè¯ç±»å‹ï¼Œåˆ™æ„å‘³ç€ï¼Œä¸¤ç«¯éƒ½éœ€è¦æ·»åŠ åª’ä½“æµè¿›è¡Œè¾“å‡ºã€‚
     * æœ¬åœ° ICE å€™é€‰ä¿¡æ¯é‡‡é›†å®Œæˆåï¼Œé€šè¿‡ä¿¡ä»¤æœåŠ¡è¿›è¡Œäº¤æ¢ã€‚
     * å‘¼å«ç«¯ï¼ˆå¥½æ¯” A ç»™ B æ‰“è§†é¢‘ç”µè¯ï¼ŒA ä¸ºå‘¼å«ç«¯ï¼‰å‘èµ· offer ä¿¡æ¯ï¼Œæ¥æ”¶ç«¯æ¥æ”¶å¹¶è¿”å›ä¸€ä¸ª answer ä¿¡æ¯ï¼Œå‘¼å«ç«¯ä¿å­˜ï¼Œå®Œæˆè¿æ¥ã€‚
### æœ¬åœ° 1 v 1 å¯¹ç­‰è¿æ¥
  åŸºç¡€æµç¨‹è®²å®Œäº†ï¼Œé‚£ä¹ˆæ˜¯éª¡å­æ˜¯é©¬æ‹‰å‡ºæ¥æºœæºœã€‚æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªæœ¬åœ°çš„å¯¹ç­‰è¿æ¥ï¼Œå€Ÿæ­¤ç†Ÿæ‚‰ä¸€ä¸‹æµç¨‹å’Œéƒ¨åˆ† APIã€‚æœ¬åœ°è¿æ¥ï¼Œæ„æ€å°±æ˜¯ä¸ç»è¿‡æœåŠ¡ï¼Œåœ¨æœ¬åœ°é¡µé¢çš„ä¸¤ä¸ª video ä¹‹é—´è¿›è¡Œè¿æ¥ã€‚ç®—äº†ï¼Œè¿˜æ˜¯ä¸Šå›¾å§ï¼Œä¸€çœ‹å°±æ‡‚ã€‚
  
  ![](https://user-gold-cdn.xitu.io/2019/3/16/16986acdf2e662b0?w=480&h=208&f=gif&s=508424)
  
  æ˜ç¡®ä¸€ä¸‹ç›®æ ‡ï¼ŒA ä½œä¸ºè¾“å‡ºç«¯ï¼Œéœ€è¦è·å–åˆ°æœ¬åœ°æµå¹¶æ·»åŠ åˆ°è‡ªå·±çš„ RTCPeerConnectionï¼›B ä½œä¸ºå‘¼å«ç«¯ï¼Œå¹¶æ²¡æœ‰è¾“å‡ºçš„éœ€æ±‚ï¼Œå› æ­¤åªéœ€è¦æ¥æ”¶æµã€‚
  #### åˆ›å»ºåª’ä½“æµ
  
  é¡µé¢å¸ƒå±€å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸¤ä¸ª video æ ‡ç­¾ï¼Œåˆ†åˆ«ä»£è¡¨ A å’Œ Bã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ï¼Œè™½ç„¶æºç æ˜¯ç”¨ Vue æ„å»ºçš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç”¨åˆ°ç‰¹åˆ«çš„ APIï¼Œæ•´ä½“ä¸Šå’Œ es6 çš„ class è¯­æ³•ç›¸å·®ä¸å¤§ï¼Œè€Œä¸”éƒ½æœ‰è¯¦ç»†çš„æ³¨é‡Šï¼Œæ‰€ä»¥å»ºè®®æ²¡æœ‰ Vue åŸºç¡€çš„åŒå­¦å¯ä»¥ç›´æ¥å½“æˆ es6 æ¥é˜…è¯»ã€‚ç¤ºä¾‹ **æºç åº“** [webrtc-stream](https://github.com/wuyawei/webrtc-stream)
  ``` javascrit
    async createMedia() {
        // ä¿å­˜æœ¬åœ°æµåˆ°å…¨å±€
        this.localstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
        let video = document.querySelector('#rtcA');
        video.srcObject = this.localstream;
        this.initPeer(); // è·å–åˆ°åª’ä½“æµåï¼Œè°ƒç”¨å‡½æ•°åˆå§‹åŒ– RTCPeerConnection
    }
  ```
  #### åˆå§‹åŒ– RTCPeerConnection
  ``` javascript
    initPeer() {
        ...
        this.peerA.addStream(this.localstream); // æ·»åŠ æœ¬åœ°æµ
        this.peerA.onicecandidate = (event) => {
        // ç›‘å¬ A çš„ICEå€™é€‰ä¿¡æ¯ å¦‚æœæ”¶é›†åˆ°ï¼Œå°±æ·»åŠ ç»™ B è¿æ¥çŠ¶æ€
            if (event.candidate) {
                this.peerB.addIceCandidate(event.candidate);
            }
        };
        ...
        // ç›‘å¬æ˜¯å¦æœ‰åª’ä½“æµæ¥å…¥ï¼Œå¦‚æœæœ‰å°±èµ‹å€¼ç»™ rtcB çš„ src
        this.peerB.onaddstream = (event) => {
            let video = document.querySelector('#rtcB');
            video.srcObject = event.stream;
        };
        this.peerB.onicecandidate = (event) => { è¿æ¥çŠ¶æ€
        // ç›‘å¬ B çš„ICEå€™é€‰ä¿¡æ¯ å¦‚æœæ”¶é›†åˆ°ï¼Œå°±æ·»åŠ ç»™ A
            if (event.candidate) {
                this.peerA.addIceCandidate(event.candidate);
            }
        };
    }
  ```
  è¿™éƒ¨åˆ†ä¸»è¦å°±æ˜¯åˆ†åˆ«åˆ›å»º peer å®ä¾‹ï¼Œå¹¶äº’ç›¸äº¤æ¢ ICE ä¿¡æ¯ã€‚ä¸è¿‡æœ‰ä¸€ä¸ªå±æ€§éœ€è¦åœ¨è¿™é‡Œæä¸€ä¸‹ï¼Œå°±æ˜¯ iceConnectionStateã€‚
  ``` javascript
    peer.oniceconnectionstatechange = (evt) => {
        console.log('ICE connection state change: ' + evt.target.iceConnectionState);
    };
  ```
  æˆ‘ä»¬å¯ä»¥é€šè¿‡ `oniceconnectionstatechange` æ–¹æ³•æ¥ç›‘æµ‹ ICE è¿æ¥çš„çŠ¶æ€ï¼Œå®ƒä¸€å…±æœ‰ä¸ƒç§çŠ¶æ€ï¼š
  ```
new        ICEä»£ç†æ­£åœ¨æ”¶é›†å€™é€‰äººæˆ–ç­‰å¾…æä¾›è¿œç¨‹å€™é€‰äººã€‚
checking   ICEä»£ç†å·²ç»åœ¨è‡³å°‘ä¸€ä¸ªç»„ä»¶ä¸Šæ¥æ”¶äº†è¿œç¨‹å€™é€‰è€…ï¼Œå¹¶ä¸”æ­£åœ¨æ£€æŸ¥å€™é€‰ä½†å°šæœªæ‰¾åˆ°è¿æ¥ã€‚é™¤äº†æ£€æŸ¥ï¼Œå®ƒå¯èƒ½è¿˜åœ¨æ”¶é›†ã€‚
connected  ICEä»£ç†å·²æ‰¾åˆ°æ‰€æœ‰ç»„ä»¶çš„å¯ç”¨è¿æ¥ï¼Œä½†ä»åœ¨æ£€æŸ¥å…¶ä»–å€™é€‰å¯¹ä»¥æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æ›´å¥½çš„è¿æ¥ã€‚å®ƒå¯èƒ½è¿˜åœ¨æ”¶é›†ã€‚
completed  ICEä»£ç†å·²å®Œæˆæ”¶é›†å’Œæ£€æŸ¥ï¼Œå¹¶æ‰¾åˆ°æ‰€æœ‰ç»„ä»¶çš„è¿æ¥ã€‚
failed     ICEä»£ç†å·²å®Œæˆæ£€æŸ¥æ‰€æœ‰å€™é€‰å¯¹ï¼Œä½†æœªèƒ½æ‰¾åˆ°è‡³å°‘ä¸€ä¸ªç»„ä»¶çš„è¿æ¥ã€‚å¯èƒ½å·²æ‰¾åˆ°æŸäº›ç»„ä»¶çš„è¿æ¥ã€‚
disconnected ICE è¿æ¥æ–­å¼€
closed      ICEä»£ç†å·²å…³é—­ï¼Œä¸å†å“åº”STUNè¯·æ±‚ã€‚
  ```
  æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ completed å’Œ disconnectedï¼Œä¸€ä¸ªæ˜¯å®Œæˆè¿æ¥æ—¶è§¦å‘ï¼Œä¸€ä¸ªåœ¨æ–­å¼€è¿æ¥æ—¶è§¦å‘ã€‚
  #### åˆ›å»ºè¿æ¥
  ``` javascript
    async call() {
        if (!this.peerA || !this.peerB) { // åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”å®ä¾‹ï¼Œæ²¡æœ‰å°±é‡æ–°åˆ›å»º
            this.initPeer();
        }
        try {
            let offer = await this.peerA.createOffer(this.offerOption); // åˆ›å»º offer
            await this.onCreateOffer(offer);
        } catch (e) {
            console.log('createOffer: ', e);
        }
    }
  ```
  è¿™é‡Œéœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”å®ä¾‹ï¼Œæ˜¯ä¸ºäº†æŒ‚æ–­ä¹‹ååˆé‡æ–°å‘¼å«åšçš„å¤„ç†ã€‚
  ``` javascript
    async onCreateOffer(desc) {
        try {
            await this.peerB.setLocalDescription(desc); // å‘¼å«ç«¯è®¾ç½®æœ¬åœ° offer æè¿°
        } catch (e) {
            console.log('Offer-setLocalDescription: ', e);
        }
        try {
            await this.peerA.setRemoteDescription(desc); // æ¥æ”¶ç«¯è®¾ç½®è¿œç¨‹ offer æè¿°
        } catch (e) {
            console.log('Offer-setRemoteDescription: ', e);
        }
        try {
            let answer = await this.peerA.createAnswer(); // æ¥æ”¶ç«¯åˆ›å»º answer
            await this.onCreateAnswer(answer);
        } catch (e) {
            console.log('createAnswer: ', e);
        }
    },
    async onCreateAnswer(desc) {
        try {
            await this.peerA.setLocalDescription(desc); // æ¥æ”¶ç«¯è®¾ç½®æœ¬åœ° answer æè¿°
        } catch (e) {
            console.log('answer-setLocalDescription: ', e);
        }
        try {
            await this.peerB.setRemoteDescription(desc); // å‘¼å«ç«¯ç«¯è®¾ç½®è¿œç¨‹ answer æè¿°
        } catch (e) {
            console.log('answer-setRemoteDescription: ', e);
        }
    }
  ```
  è¿™åŸºæœ¬å°±æ˜¯ä¹‹å‰é‡å¤è¿‡å¥½å‡ æ¬¡çš„æµç¨‹ç”¨ä»£ç å†™å‡ºæ¥è€Œå·²ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ€è·¯åº”è¯¥æ¯”è¾ƒæ¸…æ™°äº†ã€‚ä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå°±æ˜¯ç°åœ¨è¿™ç§æƒ…å†µï¼ŒA ä½œä¸ºå‘¼å«ç«¯ï¼ŒB ä¸€æ ·æ˜¯å¯ä»¥æ‹¿åˆ° A çš„åª’ä½“æµçš„ã€‚å› ä¸ºè¿æ¥ä¸€æ—¦å»ºç«‹äº†ï¼Œå°±æ˜¯åŒå‘çš„ï¼Œåªä¸è¿‡ B åˆå§‹åŒ– peer çš„æ—¶å€™æ²¡æœ‰æ·»åŠ æœ¬åœ°æµï¼Œæ‰€ä»¥ A ä¸ä¼šæœ‰ B çš„åª’ä½“æµã€‚
### ç½‘ç»œ 1 v 1 å¯¹ç­‰è¿æ¥
  æƒ³å¿…åŸºæœ¬æµç¨‹å¤§å®¶éƒ½å·²ç»ç†Ÿæ‚‰äº†ï¼Œé€šè¿‡å›¾è§£ã€å®ä¾‹æ¥æ¥å›å›è®²äº†å¥½å‡ éã€‚æ‰€ä»¥è¶çƒ­æ‰“é“ï¼Œæˆ‘ä»¬è¿™æ¬¡æŠŠæœåŠ¡åŠ ä¸Šï¼Œåšä¸€ä¸ªçœŸæ­£çš„ç‚¹å¯¹ç‚¹è¿æ¥ã€‚åœ¨çœ‹ä¸‹é¢çš„æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å¸Œæœ›ä½ æœ‰ä¸€ç‚¹ç‚¹ Koa å’Œ Scoket.io çš„åŸºç¡€ï¼Œäº†è§£ä¸€äº›åŸºæœ¬ API å³å¯ã€‚ä¸ç†Ÿæ‚‰çš„åŒå­¦ä¹Ÿä¸è¦ç´§ï¼Œç°åœ¨çœ‹ä¹Ÿæ¥å¾—åŠï¼Œ[Koa](https://koa.bootcss.com/)ã€[Socke.io](https://www.w3cschool.cn/socket/socket-ulbj2eii.html)ï¼Œæˆ–è€…å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç«  [Vchat - ä¸€ä¸ªç¤¾äº¤èŠå¤©ç³»ç»Ÿï¼ˆvue + node + mongodbï¼‰](https://juejin.im/post/5c0a00fb6fb9a049d4419d3a)ã€‚
#### éœ€æ±‚

  è¿˜æ˜¯è€è§„çŸ©ï¼Œå…ˆäº†è§£ä¸€ä¸‹éœ€æ±‚ã€‚å›¾ç‰‡åŠ è½½æ…¢ï¼Œå¯ä»¥ç›´æ¥çœ‹[æ¼”ç¤ºåœ°å€](https://webrtc-stream-txrdcybqae.now.sh/#/)
  
  ![](https://user-gold-cdn.xitu.io/2019/3/17/16989e02332169d9?w=600&h=203&f=png&s=88263)
  
  è¿æ¥è¿‡ç¨‹æ¶‰åŠåˆ°å¤šä¸ªç¯èŠ‚ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€æˆªå›¾äº†ï¼Œå¯ä»¥ç›´æ¥å»æ¼”ç¤ºåœ°å€æŸ¥çœ‹ã€‚ç®€å•åˆ†æä¸€ä¸‹æˆ‘ä»¬è¦åšçš„äº‹æƒ…ï¼š
    * åŠ å…¥æˆ¿é—´åï¼Œè·å–åˆ°æˆ¿é—´çš„æ‰€æœ‰åœ¨çº¿æˆå‘˜ã€‚
    * é€‰æ‹©ä»»ä¸€æˆå‘˜è¿›è¡Œé€šè¯ï¼Œä¹Ÿå°±æ˜¯å‘¼å«åŠ¨ä½œã€‚è¿™æ—¶å€™å°±æœ‰ä¸€äº›ç»†èŠ‚é—®é¢˜è¦å¤„ç†ï¼šä¸èƒ½å‘¼å«è‡ªå·±ã€åŒä¸€æ—¶åˆ»åªå…è®¸å‘¼å«ä¸€ä¸ªäººä¸”éœ€è¦åˆ¤æ–­å¯¹æ–¹æ˜¯å¦æ˜¯é€šè¯ä¸­ã€å‘¼å«åå›å¤éœ€è¦æœ‰ç›¸åº”åˆ¤æ–­ï¼ˆåŒæ„ã€æ‹’ç»ä»¥åŠé€šè¯ä¸­ï¼‰
    * æ‹’ç»æˆ–é€šè¯ä¸­ï¼Œéƒ½æ²¡æœ‰åç»­åŠ¨ä½œï¼Œå¯ä»¥æ¢ä¸ªäººå†å‘¼å«ã€‚åŒæ„ä¹‹åï¼Œå°±è¦å¼€å§‹å»ºç«‹ç‚¹å¯¹ç‚¹è¿æ¥ã€‚
#### åŠ å…¥æˆ¿é—´

  ç®€å•çœ‹ä¸€ä¸‹åŠ å…¥æˆ¿é—´çš„æµç¨‹ï¼š
  ``` javascript
    // å‰ç«¯
    join() {
        if (!this.account) return;
        this.isJoin = true; // è¾“å…¥æ¡†å¼¹å±‚é€»è¾‘
        window.sessionStorage.account = this.account; // åˆ·æ–°åˆ¤æ–­æ˜¯å¦ç™»å½•è¿‡
        socket.emit('join', {roomid: this.roomid, account: this.account}); // å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚
    }
    
    // åç«¯
    const sockS = {}; // ä¸åŒå®¢æˆ·ç«¯å¯¹åº”çš„ sock å®ä¾‹
    const users = {}; // æˆå‘˜åˆ—è¡¨
    sock.on('join', data=>{
        sock.join(data.roomid, () => {
            if (!users[data.roomid]) {
                users[data.roomid] = [];
            }
            let obj = {
                account: data.account,
                id: sock.id
            };
            let arr = users[data.roomid].filter(v => v.account === data.account);
            if (!arr.length) {
                users[data.roomid].push(obj);
            }
            sockS[data.account] = sock; // ä¿å­˜ä¸åŒå®¢æˆ·ç«¯å¯¹åº”çš„ sock å®ä¾‹
             // å°†æˆ¿é—´å†…æˆå‘˜åˆ—è¡¨å‘ç»™æˆ¿é—´å†…æ‰€æœ‰äºº
            app._io.in(data.roomid).emit('joined', users[data.roomid], data.account, sock.id);
        });
    });
  ```
  åç«¯æˆå‘˜åˆ—è¡¨çš„å¤„ç†ï¼Œæ˜¯å› ä¸ºåšäº†å¤šæˆ¿é—´çš„é€»è¾‘ï¼ŒæŒ‰æ¯ä¸ªæˆ¿é—´çš„æˆå‘˜è¡¨è¿”å›çš„ã€‚ä½ ä»¬å¦‚æœåšçš„æ—¶å€™æ²¡æœ‰å¤šæˆ¿é—´ï¼Œåˆ™ä¸éœ€è¦è¿™ä¹ˆè€ƒè™‘ã€‚sockS çš„å¤„ç†ï¼Œæ˜¯ä¸ºäº†å‘é€ç§èŠæ¶ˆæ¯ã€‚
#### å‘¼å«

  å‰é¢å·²ç»è¯´äº†å‘¼å«çš„æ³¨æ„äº‹é¡¹ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸€èµ·æ¥è®²ã€‚éœ€è¦æ³¨æ„çš„å°±æ˜¯æ¶ˆæ¯ä¸­éœ€è¦å¸¦æœ‰è‡ªå·±å’Œå¯¹æ–¹çš„ accountï¼Œå› ä¸ºè¿™æ˜¯åˆ¤æ–­æˆå‘˜ sock çš„æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰å­˜å‚¨åœ¨ socks ä¸­çš„ç”¨æ¥å‘ç§èŠæ¶ˆæ¯çš„ã€‚ç„¶åæ˜¯å‰é¢è¯´çš„ä¸‰ç§çŠ¶æ€ï¼Œåœ¨è¿™é‡Œç”¨ type å€¼ 1, 2, 3 æ¥åŒºåˆ†ï¼Œç„¶åç»™å‡ºä¸åŒçš„å›å¤ã€‚
  ``` javascript
    // å‰ç«¯
    apply(account) { // å‘é€è¯·æ±‚
        // account å¯¹æ–¹account  self æ˜¯è‡ªå·±çš„account
        this.loading = true;
        this.loadingText = 'å‘¼å«ä¸­'; // å‘¼å«ä¸­ loading
        socket.emit('apply', {account: account, self: this.account});
    },
    reply(account, type) { // å¤„ç†å›å¤
        socket.emit('reply', {account: account, self: this.account, type: type});
    }
    // æ”¶åˆ°è¯·æ±‚
    socket.on('apply', data => {
        if (this.isCall) { // åˆ¤æ–­æ˜¯å¦åœ¨é€šè¯ä¸­
            this.reply(data.self, '3');
            return;
        }
        this.$confirm(data.self + ' å‘ä½ è¯·æ±‚è§†é¢‘é€šè¯, æ˜¯å¦åŒæ„?', 'æç¤º', {
            confirmButtonText: 'åŒæ„',
            cancelButtonText: 'æ‹’ç»',
            type: 'warning'
        }).then(async () => {
            this.isCall = data.self;
            this.reply(data.self, '1');
        }).catch(() => {
            this.reply(data.self, '2');
        });
    });
    
    // åç«¯
    sock.on('apply', data=>{ // è½¬å‘ç”³è¯·
        sockS[data.account].emit('apply', data);
    });
  ```
  åç«¯æ¯”è¾ƒç®€å•ï¼Œä»…ä»…æ˜¯è½¬å‘ä¸€ä¸‹è¯·æ±‚ï¼Œç»™å¯¹åº”çš„å®¢æˆ·ç«¯ã€‚å…¶å®æˆ‘ä»¬è¿™ä¸ªä¾‹å­çš„åç«¯ï¼ŒåŸºæœ¬éƒ½æ˜¯è¿™ä¸ªæ“ä½œï¼Œæ‰€ä»¥åé¢çš„åç«¯ä»£ç å°±ä¸è´´äº†ï¼Œå¯ä»¥å»æºç ç›´æ¥çœ‹ã€‚
#### å›å¤

  å›å¤å’Œå’Œå‘¼å«æ˜¯ä¸€æ ·çš„é€»è¾‘ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒçš„å›å¤å°±å¥½äº†ã€‚
  ``` javascript
    // å‰ç«¯ 
    socket.on('reply', async data =>{ // æ”¶åˆ°å›å¤
        this.loading = false;
        switch (data.type) {
            case '1': // åŒæ„
                this.isCall = data.self; // å­˜å‚¨é€šè¯å¯¹è±¡
                break;
            case '2': //æ‹’ç»
                this.$message({
                    message: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è¯·æ±‚ï¼',
                    type: 'warning'
                });
                break;
            case '3': // æ­£åœ¨é€šè¯ä¸­
                this.$message({
                    message: 'å¯¹æ–¹æ­£åœ¨é€šè¯ä¸­ï¼',
                    type: 'warning'
                });
                break;
        }
    });
  ```
#### åˆ›å»ºè¿æ¥

  å‘¼å«å’Œå›å¤çš„é€»è¾‘åŸºæœ¬æ¸…æ¥šäº†ï¼Œé‚£æˆ‘ä»¬ç»§ç»­æ€è€ƒï¼Œåº”è¯¥åœ¨ä»€ä¹ˆæ—¶æœºåˆ›å»º P2P è¿æ¥å‘¢ï¼Ÿæˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œæ‹’ç»å’Œé€šè¯ä¸­éƒ½ä¸éœ€è¦å¤„ç†ï¼Œåªæœ‰åŒæ„éœ€è¦ï¼Œé‚£å°±åº”è¯¥åœ¨åŒæ„è¯·æ±‚çš„ä½ç½®å¼€å§‹åˆ›å»ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒæ„è¯·æ±‚æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼šä¸€ä¸ªæ˜¯ä½ ç‚¹äº†åŒæ„ï¼Œå¦ä¸€ä¸ªæ˜¯å¯¹æ–¹çŸ¥é“ä½ ç‚¹äº†åŒæ„ä¹‹åã€‚
  
  æœ¬ä¾‹é‡‡å–çš„æ˜¯å‘¼å«æ–¹å‘é€ Offerï¼Œè¿™ä¸ªåœ°æ–¹ä¸€å®šå¾—æ³¨æ„ï¼Œåªè¦æœ‰ä¸€æ–¹åˆ›å»º Offer å°±å¯ä»¥äº†ï¼Œå› ä¸ºä¸€æ—¦è¿æ¥å°±æ˜¯åŒå‘çš„ã€‚
  ``` javascript
    socket.on('apply', data => { // ä½ ç‚¹åŒæ„çš„åœ°æ–¹
        ...
        this.$confirm(data.self + ' å‘ä½ è¯·æ±‚è§†é¢‘é€šè¯, æ˜¯å¦åŒæ„?', 'æç¤º', {
            confirmButtonText: 'åŒæ„',
            cancelButtonText: 'æ‹’ç»',
            type: 'warning'
        }).then(async () => {
            await this.createP2P(data); // åŒæ„ä¹‹ååˆ›å»ºè‡ªå·±çš„ peer ç­‰å¾…å¯¹æ–¹çš„ offer
            ... // è¿™é‡Œä¸å‘ offer
        })
        ...
    });
    socket.on('reply', async data =>{ // å¯¹æ–¹çŸ¥é“ä½ ç‚¹äº†åŒæ„çš„åœ°æ–¹
        switch (data.type) {
            case '1': // åªæœ‰è¿™é‡Œå‘ offer
                await this.createP2P(data); // å¯¹æ–¹åŒæ„ä¹‹ååˆ›å»ºè‡ªå·±çš„ peer
                this.createOffer(data); // å¹¶ç»™å¯¹æ–¹å‘é€ offer
                break;
            ...
        }
    });
  ```
  
  å’Œå¾®ä¿¡ç­‰è§†é¢‘é€šè¯ä¸€æ ·ï¼ŒåŒæ–¹éƒ½éœ€è¦è¿›è¡Œåª’ä½“æµè¾“å‡ºï¼Œå› ä¸ºä½ ä»¬éƒ½è¦çœ‹è§å¯¹æ–¹ã€‚æ‰€ä»¥è¿™é‡Œå’Œä¹‹å‰æœ¬åœ°å¯¹ç­‰è¿æ¥çš„åŒºåˆ«å°±æ˜¯éƒ½éœ€è¦ç»™è‡ªå·±çš„ RTCPeerConnection å®ä¾‹æ·»åŠ åª’ä½“æµï¼Œç„¶åè¿æ¥åå„è‡ªéƒ½èƒ½æ‹¿åˆ°å¯¹æ–¹çš„è§†é¢‘æµã€‚åœ¨ åˆå§‹åŒ– RTCPeerConnection æ—¶ï¼Œè®°å¾—åŠ ä¸Š onicecandidate å‡½æ•°ï¼Œç”¨ä»¥ç»™å¯¹æ–¹å‘é€ ICE å€™é€‰ã€‚
  ``` javascript
    async createP2P(data) {
        this.loading = true; // loadingåŠ¨ç”»
        this.loadingText = 'æ­£åœ¨å»ºç«‹é€šè¯è¿æ¥';
        await this.createMedia(data);
    },
    async createMedia(data) {
        ... // è·å–å¹¶å°†æœ¬åœ°æµèµ‹å€¼ç»™ video  åŒä¹‹å‰
        this.initPeer(data); // è·å–åˆ°åª’ä½“æµåï¼Œè°ƒç”¨å‡½æ•°åˆå§‹åŒ– RTCPeerConnection
    },
    initPeer(data) {
        // åˆ›å»ºè¾“å‡ºç«¯ PeerConnection
        ...
        this.peer.addStream(this.localstream); // éƒ½éœ€è¦æ·»åŠ æœ¬åœ°æµ
        this.peer.onicecandidate = (event) => {
        // ç›‘å¬ICEå€™é€‰ä¿¡æ¯ å¦‚æœæ”¶é›†åˆ°ï¼Œå°±å‘é€ç»™å¯¹æ–¹
            if (event.candidate) { // å‘é€ ICE å€™é€‰
                socket.emit('1v1ICE',
                {account: data.self, self: this.account, sdp: event.candidate});
            }
        };
        this.peer.onaddstream = (event) => {
        // ç›‘å¬æ˜¯å¦æœ‰åª’ä½“æµæ¥å…¥ï¼Œå¦‚æœæœ‰å°±èµ‹å€¼ç»™ rtcB çš„ srcï¼Œæ”¹å˜ç›¸åº”loadingçŠ¶æ€ï¼Œèµ‹å€¼çœç•¥
            this.isToPeer = true;
            this.loading = false;
            ...
        };
    }
  ```
  createOffer ç­‰ä¿¡æ¯äº¤æ¢å’Œä¹‹å‰ä¸€æ ·ï¼Œåªæ˜¯éœ€è¦é€šè¿‡ Socket è½¬å‘ç»™å¯¹åº”çš„å®¢æˆ·ç«¯ã€‚ç„¶åå„è‡ªæ¥æ”¶åˆ°æ¶ˆæ¯ååˆ†åˆ«é‡‡å–å¯¹åº”çš„æªæ–½ã€‚
  ``` javascript
    socket.on('1v1answer', (data) =>{ // æ¥æ”¶åˆ° answer
        this.onAnswer(data);
    });
    socket.on('1v1ICE', (data) =>{ // æ¥æ”¶åˆ° ICE
        this.onIce(data);
    });
    socket.on('1v1offer', (data) =>{ // æ¥æ”¶åˆ° offer
        this.onOffer(data);
    });
    
    // è¿™é‡Œåªè´´ä¸€ä¸ª createOffer çš„ä»£ç ï¼Œå› ä¸ºå’Œä¹‹å‰çš„æ€è·¯éƒ½ä¸€æ ·ï¼Œåªæ˜¯å†™æ³•æœ‰äº›åŒºåˆ«
    // å»ºè®®å¤§å®¶éƒ½è‡ªå·±æ•²ä¸€éï¼Œæœ‰é—®é¢˜å¯ä»¥äº¤æµï¼Œä¹Ÿå¯ä»¥å»æºç æŸ¥çœ‹ã€‚
    async createOffer(data) { // åˆ›å»ºå¹¶å‘é€ offer
        try {
            // åˆ›å»ºoffer
            let offer = await this.peer.createOffer(this.offerOption);
            // å‘¼å«ç«¯è®¾ç½®æœ¬åœ° offer æè¿°
            await this.peer.setLocalDescription(offer);
            // ç»™å¯¹æ–¹å‘é€ offer
            socket.emit('1v1offer', {account: data.self, self: this.account, sdp: offer});
        } catch (e) {
            console.log('createOffer: ', e);
        }
    }
  ```
#### æŒ‚æ–­

  æŒ‚æ–­çš„æ€è·¯ä¾ç„¶æ˜¯å°†å„è‡ªçš„ peer å…³é—­ï¼Œä½†æ˜¯è¿™é‡ŒæŒ‚æ–­æ–¹è¿˜éœ€è¦å€ŸåŠ© Socket å‘Šè¯‰å¯¹æ–¹ï¼Œä½ å·²ç»æŒ‚ç”µè¯äº†ï¼Œä¸ç„¶å¯¹æ–¹è¿˜åœ¨ç—´ç—´åœ°ç­‰ã€‚
  ``` javascript
    hangup() { // æŒ‚æ–­é€šè¯ å¹¶åšç›¸åº”å¤„ç† å¯¹æ–¹æ”¶åˆ°æ¶ˆæ¯åä¸€æ ·éœ€è¦å…³é—­è¿æ¥
        socket.emit('1v1hangup', {account: this.isCall, self: this.account});
        this.peer.close();
        this.peer = null;
        this.isToPeer = false;
        this.isCall = false;
    }
  ```
##  å‚è€ƒæ–‡ç« 
* [WebRTC](https://hpbn.co/webrtc/#incremental-provisioning-trickle-ice)
* [WebRTC ç›´æ’­æ—¶ä»£](https://www.villainhr.com/page/2017/02/20/WebRTC%20%E7%9B%B4%E6%92%AD%E6%97%B6%E4%BB%A3)

## åè®°
  å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œï¼Œä¸”æœ¬æ–‡å¯¹ä½ æœ‰ä¸€ç‚¹å¸®åŠ©çš„è¯ï¼Œå¸Œæœ›ä½ å¯ä»¥åŠ¨åŠ¨å°æ‰‹æ”¯æŒä¸€ä¸‹ä½œè€…ï¼Œæ„Ÿè°¢ğŸ»ã€‚æ–‡ä¸­å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æŒ‡å‡ºï¼Œå…±å‹‰ã€‚

* æœ¬æ–‡ç¤ºä¾‹ **æºç åº“** [webrtc-stream](https://github.com/wuyawei/webrtc-stream)
* **æ–‡ç« ä»“åº“** [ğŸ¹ğŸ°fe-code](https://github.com/wuyawei/fe-code)

å¾€æœŸæ–‡ç« ï¼š
* [JavaScript åŸå‹å’ŒåŸå‹é“¾åŠ canvas éªŒè¯ç å®è·µ](https://juejin.im/post/5c7b524ee51d453ee81877a7)
* [ç«™ä½ï¼Œä½ è¿™ä¸ªPromiseï¼](https://juejin.im/post/5c179aad5188256d9832fb61)
* [ğŸ’˜ğŸ¦ğŸ™ˆVchat â€” ä»å¤´åˆ°è„šï¼Œæ’¸ä¸€ä¸ªç¤¾äº¤èŠå¤©ç³»ç»Ÿï¼ˆvue + node + mongodbï¼‰](https://juejin.im/post/5c0a00fb6fb9a049d4419d3a)

## å…¬ä¼—å·
æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ä¸‹æˆ‘çš„å…¬ä¼—å· **å‰ç«¯å‘åŠ¨æœº**ï¼Œå¥½ç©åˆæœ‰æ–™ã€‚

![](https://user-gold-cdn.xitu.io/2019/7/21/16c14d1d0f3be11e?w=400&h=400&f=jpeg&s=34646)

## äº¤æµç¾¤

> å¾®ä¿¡ç¾¤è¯·åŠ æˆ‘å¾®ä¿¡ï¼Œå›å¤åŠ ç¾¤

![](https://raw.githubusercontent.com/wuyawei/fe-code/master/user.jpg)